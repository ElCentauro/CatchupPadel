<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Catch Up Padel - Inicio (RedirecciÃ³n Jugador a Perfil)</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

Â  <style>
Â  Â  /* === VARIABLES CSS === */
Â  Â  :root {
Â  Â  Â  --primary-color: #ff9500;
Â  Â  Â  --primary-hover-color: #e07e00;
Â  Â  Â  --secondary-color: #2c3e50;
Â  Â  Â  --text-color: #333;
Â  Â  Â  --text-light: #fff;
Â  Â  Â  --text-muted: #777;
Â  Â  Â  --background-light: #f8f8f8;
Â  Â  Â  --background-white: #fff;
Â  Â  Â  --success-color: #27ae60;
Â  Â  Â  --success-hover-color: #219150;
Â  Â  Â  --error-color: #ff4d4d;
Â  Â  Â  --border-color: #eaeaea;
Â  Â  Â  --shadow-color: rgba(0,0,0,0.1);
Â  Â  Â  --modal-overlay-color: rgba(0,0,0,0.5);
Â  Â  Â  --modal-bg-color: rgba(255, 255, 255, 0.15);
Â  Â  Â  --modal-border-color: rgba(255, 255, 255, 0.3);
Â  Â  Â  --modal-input-bg: rgba(255, 255, 255, 0.25);
Â  Â  Â  --modal-input-focus-bg: rgba(255, 255, 255, 0.35);
Â  Â  Â  --modal-placeholder-color: rgba(255, 255, 255, 0.8);
Â  Â  Â  --modal-link-color: #f1c40f;

Â  Â  Â  --font-family: 'Poppins', sans-serif;
Â  Â  Â  --base-font-size: 16px;
Â  Â  Â  --border-radius: 0.5rem;
Â  Â  Â  --transition-speed: 0.3s;
Â  Â  }

Â  Â  /* === RESET y estilos generales === */
Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  html { font-size: var(--base-font-size); }
Â  Â  body {
Â  Â  Â  font-family: var(--font-family);
Â  Â  Â  color: var(--text-color);
Â  Â  Â  background-color: var(--background-light);
Â  Â  Â  overflow-x: hidden;
Â  Â  Â  line-height: 1.6;
Â  Â  }
Â  Â  a { text-decoration: none; color: inherit; }
Â  Â  button {
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-family: var(--font-family);
Â  Â  Â  border: none;
Â  Â  Â  border-radius: var(--border-radius);
Â  Â  Â  transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, opacity var(--transition-speed) ease;
Â  Â  }
Â  Â  button:disabled { opacity: 0.7; cursor: not-allowed; }
Â  Â  img { max-width: 100%; height: auto; display: block; }
Â  Â  .visually-hidden {
Â  Â  Â  position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
Â  Â  Â  overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
Â  Â  }
    /* Clase para ocultar elementos con display none */
    .hidden {
        display: none !important;
    }

Â  Â  /* === Barra de navegaciÃ³n === */
Â  Â  nav {
Â  Â  Â  display: flex; align-items: center; justify-content: space-between;
Â  Â  Â  padding: 1rem 1.5rem; background-color: var(--background-white);
Â  Â  Â  box-shadow: 0 2px 4px var(--shadow-color); position: relative;
Â  Â  }
Â  Â  /* Estilos para el logo de imagen */
    .logo img {
      max-height: 40px; /* Ajusta el tamaÃ±o del logo */
      width: auto;
      display: block;
    }
    .logo {
        display: flex; /* Para centrar la imagen verticalmente si es necesario */
        align-items: center;
        /* Puedes quitar las propiedades de fuente si solo usas imagen */
        /* font-size: 1.6rem; */
        /* font-weight: 600; */
        /* color: var(--secondary-color); */
    }

Â  Â  .nav-right { display: none; align-items: center; gap: 1rem; }
    /* Contenedor para los botones de auth */
    .auth-buttons-container,
    .logged-in-container {
        display: flex;
        gap: inherit; /* Hereda el gap de .nav-right */
        flex-direction: inherit; /* Hereda la direcciÃ³n de .nav-right */
    }
Â  Â  .nav-button {
Â  Â  Â  padding: 0.5rem 1rem; background-color: var(--primary-color);
Â  Â  Â  color: var(--text-light); font-weight: 500; white-space: nowrap;
Â  Â  }
Â  Â  .nav-button:hover:not(:disabled) { background-color: var(--primary-hover-color); }

    /* Estilo especÃ­fico para el botÃ³n de logout si lo deseas */
    .nav-button-logout {
        background-color: var(--secondary-color); /* O algÃºn color diferente */
    }
    .nav-button-logout:hover:not(:disabled) {
        background-color: #34495e; /* Un tono mÃ¡s oscuro */
    }

Â  Â  .hamburger-button {
Â  Â  Â  display: block; background: none; border: none; font-size: 1.8rem;
Â  Â  Â  cursor: pointer; padding: 0.5rem; line-height: 1; color: var(--secondary-color);
Â  Â  }
Â  Â  .nav-right.mobile-nav-active {
Â  Â  Â  display: flex; flex-direction: column; position: absolute;
Â  Â  Â  top: 100%; right: 0; background-color: var(--background-white);
Â  Â  Â  width: 200px; padding: 1rem; box-shadow: 0 4px 8px var(--shadow-color);
Â  Â  Â  z-index: 1000; gap: 1rem; align-items: stretch;
Â  Â  }
    /* Asegura que los contenedores internos tambiÃ©n sean columna en mÃ³vil */
    .nav-right.mobile-nav-active .auth-buttons-container,
    .nav-right.mobile-nav-active .logged-in-container {
        flex-direction: column;
    }
Â  Â  .nav-right.mobile-nav-active .nav-button { text-align: center; }


Â  Â  /* === SecciÃ³n principal (hero) === */
Â  Â  .hero {
Â  Â  Â  padding: 3rem 1rem; text-align: center;
Â  Â  Â  background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)),
Â  Â  Â  Â  Â  Â  Â  Â  Â  url('https://images.unsplash.com/photo-1593341646581-529f6c49c5d1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80');
Â  Â  Â  background-size: cover; background-position: center; color: var(--text-light);
Â  Â  }
Â  Â  .hero h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; max-width: 90%; margin-left: auto; margin-right: auto; }
Â  Â  .hero p { font-size: 1rem; font-weight: 400; max-width: 90%; margin: 0 auto 2rem auto; line-height: 1.6; }
Â  Â  .hero-image {
Â  Â  Â  margin: 2rem auto; max-width: 600px; width: 80%;
Â  Â  Â  border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  .hero-buttons { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
Â  Â  .hero-button { padding: 0.75rem 1.5rem; border-radius: var(--border-radius); border: 1px solid transparent; font-weight: 500; font-size: 1rem; }
Â  Â  .hero-button-primary { background-color: var(--primary-color); color: var(--text-light); }
Â  Â  .hero-button-primary:hover:not(:disabled) { background-color: var(--primary-hover-color); }
Â  Â  .hero-button-secondary { background-color: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); }
Â  Â  .hero-button-secondary:hover:not(:disabled) { background-color: var(--primary-color); color: var(--text-light); }

Â  Â  /* === Footer === */
Â  Â  footer { text-align: center; padding: 1.5rem 1rem; font-size: 0.9rem; color: var(--text-muted); background-color: var(--background-white); border-top: 1px solid var(--border-color); margin-top: 3rem; }

Â  Â  /* === Modal de autenticaciÃ³n === */
Â  Â  #auth-section { position: fixed; inset: 0; display: none; justify-content: center; align-items: center; background: var(--modal-overlay-color); z-index: 9999; padding: 1rem; }
Â  Â  .auth-container {
Â  Â  Â  background: var(--modal-bg-color); backdrop-filter: blur(10px); border: 1px solid var(--modal-border-color);
Â  Â  Â  border-radius: 15px; padding: 25px; width: 95%; max-width: 400px; text-align: center; color: var(--text-light);
Â  Â  Â  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); animation: fadeIn 0.5s ease forwards; position: relative; overflow-y: auto; max-height: 90vh;
Â  Â  }
Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
Â  Â  .auth-container h2 { margin-bottom: 20px; font-size: 1.8rem; font-weight: 600; letter-spacing: 1px; }
Â  Â  #auth-form { display: flex; flex-direction: column; gap: 15px; }
Â  Â  #auth-form input[type="email"],
Â  Â  #auth-form input[type="password"],
    #auth-form input[type="text"],
    #auth-form .password-input-container input { /* Estilo tambiÃ©n para input dentro del contenedor */
Â  Â  Â  width: 100%; padding: 12px 15px; border: none; border-radius: 8px; background: var(--modal-input-bg);
Â  Â  Â  color: var(--text-light); font-size: 1rem; outline: none; transition: background var(--transition-speed) ease;
        /* AÃ±adir padding a la derecha para el icono de password */
        padding-right: 40px;
        margin-bottom: 0; /* Quitar margen si el error va debajo */
Â  Â  }
Â  Â  #auth-form input:focus { background: var(--modal-input-focus-bg); }
Â  Â  #auth-form input::placeholder { color: var(--modal-placeholder-color); opacity: 1; }

    /* Estilos para los mensajes de error por campo */
    .field-error {
        color: var(--error-color);
        font-size: 0.85rem;
        text-align: left;
        margin-top: 4px; /* Espacio entre input y error */
        min-height: 1.2em; /* Para evitar saltos de layout */
        padding-left: 10px; /* PequeÃ±a identaciÃ³n */
    }
    /* Contenedor para el input y el error */
    .form-field-container {
        display: flex;
        flex-direction: column;
        gap: 4px; /* Espacio entre input y mensaje de error */
    }


    /* Estilos para el toggle de visibilidad de contraseÃ±a */
    .password-input-container {
        position: relative;
        width: 100%;
    }
    .toggle-password {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--modal-placeholder-color); /* O un color que contraste */
        cursor: pointer;
        font-size: 1rem;
        padding: 5px;
        line-height: 1;
        z-index: 2; /* Asegura que estÃ© por encima del input */
    }
     .toggle-password:hover {
        color: var(--text-light);
    }


Â  Â  #auth-form button[type="submit"] {
Â  Â  Â  padding: 12px; border: none; border-radius: 8px; background: var(--success-color); color: var(--text-light);
Â  Â  Â  font-size: 1.1rem; font-weight: 600; margin-top: 10px;
Â  Â  }
Â  Â  #auth-form button[type="submit"]:hover:not(:disabled) { background: var(--success-hover-color); }
Â  Â  .toggle-link { margin-top: 20px; font-size: 0.9rem; }
Â  Â  .toggle-link a { color: var(--modal-link-color); text-decoration: none; font-weight: 600; cursor: pointer; }
Â  Â  .toggle-link a:hover { text-decoration: underline; }
Â  Â  /* Mensaje general (usado para procesando, Ã©xito, errores no especÃ­ficos de campo) */
Â  Â  .message { margin-top: 15px; font-size: 0.95rem; min-height: 20px; font-weight: 500; }

Â  Â  #role-selection { display: flex; justify-content: space-around; margin-top: 5px; margin-bottom: 5px; flex-wrap: wrap; gap: 10px; }
Â  Â  .role-option { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-light); } /* Color de texto para las opciones de rol */
Â  Â  .role-option label { cursor: pointer; }
    /* Asegurar que los inputs de radio se vean */
    .role-option input[type="radio"] {
        -webkit-appearance: radio;
        -moz-appearance: radio;
        appearance: radio;
        accent-color: var(--primary-color); /* Color del radio button */
        margin: 0; /* Quitar margen por defecto */
        width: auto; /* Asegurar tamaÃ±o automÃ¡tico */
        height: auto; /* Asegurar tamaÃ±o automÃ¡tico */
    }


Â  Â  #establishment-field { display: none; flex-direction: column; gap: 10px; margin-top: 10px; }
Â  Â  .close-modal {
Â  Â  Â  position: absolute; top: 10px; right: 10px; background: var(--primary-color); border: none; border-radius: 50%;
Â  Â  Â  width: 30px; height: 30px; color: var(--text-light); font-size: 1.1rem; line-height: 30px; text-align: center;
Â  Â  Â  cursor: pointer; padding: 0; z-index: 10;
Â  Â  }
Â  Â  .close-modal:hover { background-color: var(--primary-hover-color); }

Â  Â  /* === Media Queries para Responsividad === */
Â  Â  @media (min-width: 768px) {
Â  Â  Â  nav { padding: 1rem 2rem; }
Â  Â  Â  .hamburger-button { display: none; }
Â  Â  Â  .nav-right { display: flex; position: static; flex-direction: row; width: auto; background: none; box-shadow: none; padding: 0; gap: 1.5rem; }
    /* Asegura que los contenedores internos tambiÃ©n sean fila en desktop */
     .nav-right .auth-buttons-container,
     .nav-right .logged-in-container {
        flex-direction: row;
    }

Â  Â  Â  .hero { padding: 4rem 2rem; }
Â  Â  Â  .hero h1 { font-size: 3rem; max-width: 800px; }
Â  Â  Â  .hero p { font-size: 1.15rem; max-width: 700px; }
Â  Â  Â  .auth-container { padding: 40px; }
Â  Â  Â  .auth-container h2 { font-size: 2rem; }
Â  Â  }
Â  Â  @media (min-width: 1024px) {
Â  Â  Â  .hero { padding: 5rem 2rem; }
Â  Â  Â  .hero h1 { font-size: 3.5rem; }
Â  Â  Â  .hero p { font-size: 1.25rem; }
Â  Â  }

Â  Â  /* AnimaciÃ³n Shake para Errores (Opcional) */
Â  Â  @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
Â  Â  .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

Â  </style>
</head>
<body>

Â  <nav>
Â  Â  Â  Â  <a href="/" class="logo">
        <img src="catchup2.png" alt="Logo de Catch Up Padel">
    </a>
Â  Â  <button class="hamburger-button" id="hamburger-btn" aria-label="Abrir menÃº de navegaciÃ³n" aria-expanded="false">â˜°</button>
Â  Â  <div class="nav-right" id="nav-right-container">
        Â  Â  Â  <div id="auth-buttons-container" class="auth-buttons-container">
Â  Â  Â  Â  <button class="nav-button" onclick="showAuthSection('login')">Iniciar SesiÃ³n</button>
Â  Â  Â  Â  <button class="nav-button" onclick="showAuthSection('signup')">Registrarse</button>
Â  Â  Â  </div>
        <div id="logged-in-container" class="logged-in-container hidden">
            <button class="nav-button nav-button-logout" id="logout-button">Cerrar SesiÃ³n</button>
        </div>
Â  Â  </div>
Â  </nav>

Â  <section class="hero">
Â  Â  <h1>Catch Up Padel</h1>
Â  Â  <p>Conecta con jugadores y establecimientos de pÃ¡del y disfruta del mejor deporte en comunidad.</p>
Â  Â  <img src="padel.png" alt="Imagen de pÃ¡del" class="hero-image">
Â  Â  <div class="hero-buttons">
Â  Â  Â  <button class="hero-button hero-button-primary" onclick="showAuthSection('signup')">Â¡RegÃ­strate Ahora!</button>
Â  Â  Â  <button class="hero-button hero-button-secondary" onclick="showAuthSection('login')">Iniciar SesiÃ³n</button>
Â  Â  </div>
Â  </section>

Â  <footer>
Â  Â  Â© <span id="current-year">2025</span> Catch Up Padel. Todos los derechos reservados.
Â  </footer>

Â  <div id="auth-section">
Â  Â  <div class="auth-container">
Â  Â  Â  <button class="close-modal" id="close-modal-btn" aria-label="Cerrar modal">Ã—</button>
Â  Â  Â  <h2 id="form-title">Registro</h2>
Â  Â  Â  <form id="auth-form" novalidate>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-field-container">
Â  Â  Â  Â  Â  Â  <label for="email" class="visually-hidden">Correo electrÃ³nico</label>
Â  Â  Â  Â  Â  Â  <input type="email" id="email" placeholder="Correo electrÃ³nico" required autocomplete="email">
Â  Â  Â  Â  Â  Â  <span id="email-error" class="field-error" aria-live="polite"></span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-field-container">
            <label for="password" class="visually-hidden">ContraseÃ±a</label>
            <div class="password-input-container">
Â  Â  Â  Â  Â  Â      <input type="password" id="password" placeholder="ContraseÃ±a" required autocomplete="current-password">
                <button type="button" class="toggle-password" id="toggle-password-btn" aria-label="Mostrar/Ocultar contraseÃ±a">ğŸ‘ï¸</button>
            </div>
            <span id="password-error" class="field-error" aria-live="polite"></span>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="role-selection">
Â  Â  Â  Â  Â  <div class="role-option">
Â  Â  Â  Â  Â  Â  <input type="radio" name="user-role" id="role-jugador" value="jugador" required>
Â  Â  Â  Â  Â  Â  <label for="role-jugador">Jugador</label>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="role-option">
Â  Â  Â  Â  Â  Â  <input type="radio" name="user-role" id="role-establecimiento" value="establecimiento" required>
Â  Â  Â  Â  Â  Â  <label for="role-establecimiento">Establecimiento</label>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="establishment-field">
Â  Â  Â  Â  Â  Â Â  Â  Â  Â  Â  Â  <div class="form-field-container">
Â  Â  Â  Â  Â  Â  Â  Â <label for="establishment-number" class="visually-hidden">ID de Establecimiento (Generado)</label>
Â  Â  Â  Â  Â  Â  Â  Â <input type="text" id="establishment-number" placeholder="ID de Establecimiento (Generado)" readonly>
                 Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-field-container">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="establishment-name" class="visually-hidden">Nombre del Establecimiento</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="establishment-name" placeholder="Nombre del Establecimiento" required>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="establishment-name-error" class="field-error" aria-live="polite"></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button type="submit" id="submit-button">Registrarse</button>
Â  Â  Â  </form>
Â  Â  Â  <div class="toggle-link">
Â  Â  Â  Â  <span id="toggle-signup" style="display: none;">Â¿Ya tienes cuenta?
Â  Â  Â  Â  Â  <a id="signin-link" href="#" onclick="event.preventDefault(); setMode('login');">Inicia sesiÃ³n</a>
Â  Â  Â  Â  </span>
Â  Â  Â  Â  <span id="toggle-signin">Â¿No tienes cuenta?
Â  Â  Â  Â  Â  <a id="signup-link" href="#" onclick="event.preventDefault(); setMode('signup');">RegÃ­strate</a>
Â  Â  Â  Â  </span>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="message" id="message" aria-live="polite"></div>
Â  Â  </div>
Â  </div>

Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

Â  <script>
Â  Â  // === CONFIGURACIÃ“N DE SUPABASE ===
Â  Â  const SUPABASE_URL = 'https://idlvxinjfbsujpvxncbr.supabase.co';
Â  Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkbHZ4aW5qZmJzdWpwdnhuY2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE1NTgxMTMsImV4cCI6MjA1NzEzNDExM30.kojYn4tEbQJvafypVnq2TjF5JYCpFC7cBaKKk3qTkig';
Â  Â  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

Â  Â  // === SelecciÃ³n de Elementos del DOM ===
Â  Â  const authSection = document.getElementById('auth-section');
Â  Â  const authForm = document.getElementById('auth-form');
Â  Â  const formTitle = document.getElementById('form-title');
Â  Â  const submitButton = document.getElementById('submit-button');
Â  Â  const emailInput = document.getElementById('email');
Â  Â  const passwordInput = document.getElementById('password');
Â  Â  const messageDiv = document.getElementById('message'); // Para mensajes generales
Â  Â  const authContainer = document.querySelector('.auth-container');
Â  Â  // MEJORA FUNCIONAL 3: Referencias a los nuevos contenedores de botones en la nav
Â  Â  const authButtonsContainer = document.getElementById('auth-buttons-container');
Â  Â  const loggedInContainer = document.getElementById('logged-in-container');
    const logoutButton = document.getElementById('logout-button');

Â  Â  const roleSelectionDiv = document.getElementById('role-selection');
Â  Â  const roleJugadorRadio = document.getElementById('role-jugador');
Â  Â  const roleEstablecimientoRadio = document.getElementById('role-establecimiento');
Â  Â  const establishmentField = document.getElementById('establishment-field');
Â  Â  const establishmentInput = document.getElementById('establishment-number');
Â  Â  const establishmentNameInput = document.getElementById('establishment-name');
Â  Â  const toggleSignupSpan = document.getElementById('toggle-signup');
Â  Â  const toggleSigninSpan = document.getElementById('toggle-signin');
Â  Â  const closeModalButton = document.getElementById('close-modal-btn');
Â  Â  const hamburgerBtn = document.getElementById('hamburger-btn');
Â  Â  const navRightContainer = document.getElementById('nav-right-container');
Â  Â  const currentYearSpan = document.getElementById('current-year');

    // MEJORA FUNCIONAL 1: Referencia al botÃ³n de toggle de contraseÃ±a
    const togglePasswordButton = document.getElementById('toggle-password-btn');

    // MEJORA FUNCIONAL 2: Referencias a los spans de error por campo
    const emailErrorSpan = document.getElementById('email-error');
    const passwordErrorSpan = document.getElementById('password-error');
    const establishmentNameErrorSpan = document.getElementById('establishment-name-error');


Â  Â  // === Estado de la AplicaciÃ³n ===
Â  Â  let mode = 'signup';
Â  Â  let generatedEstablishmentID = null;
Â  Â  let isSubmitting = false;

Â  Â  // === Funciones ===

    // MEJORA FUNCIONAL 2: Limpiar mensajes de error por campo
    function clearFieldErrors() {
        emailErrorSpan.textContent = '';
        passwordErrorSpan.textContent = '';
        establishmentNameErrorSpan.textContent = '';
    }

    // MEJORA FUNCIONAL 2: Validadores por campo (simples)
    function validateEmail(email) {
        // Regex simple para email
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email.trim()) return "El correo es requerido.";
        if (!re.test(String(email).toLowerCase())) return "Formato de correo invÃ¡lido.";
        return ''; // Retorna cadena vacÃ­a si es vÃ¡lido
    }

    function validatePassword(password) {
        if (!password) return "La contraseÃ±a es requerida.";
        if (password.length < 6) return "La contraseÃ±a debe tener al menos 6 caracteres.";
        return '';
    }

    function validateEstablishmentName(name) {
        if (!name.trim()) return "El nombre del establecimiento es requerido.";
        return '';
    }

    // MEJORA FUNCIONAL 2: FunciÃ³n para validar todos los campos antes de enviar a Supabase
    function validateForm() {
        clearFieldErrors(); // Limpiar errores anteriores
        let isValid = true;

        const emailError = validateEmail(emailInput.value);
        if (emailError) {
            emailErrorSpan.textContent = emailError;
            isValid = false;
        }

        const passwordError = validatePassword(passwordInput.value);
        if (passwordError) {
            passwordErrorSpan.textContent = passwordError;
            isValid = false;
        }

        // Validar campos de establecimiento solo si el rol es 'establecimiento' y el modo es 'signup'
        if (mode === 'signup' && roleEstablecimientoRadio.checked) {
            const establishmentNameError = validateEstablishmentName(establishmentNameInput.value);
             if (establishmentNameError) {
                establishmentNameErrorSpan.textContent = establishmentNameError;
                isValid = false;
            }
             // El ID de establecimiento no se valida porque es readonly
        }

        // Si el modo es signup, validar que se ha seleccionado un rol (el 'required' en los radios ya ayuda)
        if (mode === 'signup') {
            const selectedRoleElem = document.querySelector('input[name="user-role"]:checked');
            if (!selectedRoleElem) {
                // Esto podrÃ­a mostrarse en el mensaje general o cerca de los radios
                showMessage("Debes seleccionar un rol.", true);
                isValid = false;
            }
        }

        return isValid;
    }


Â  Â  function showAuthSection(newMode) {
Â  Â  Â  authSection.style.display = 'flex';
Â  Â  Â  setTimeout(() => { authContainer.style.opacity = 1; authContainer.style.transform = 'translateY(0) scale(1)'; }, 10);
Â  Â  Â  setMode(newMode);
Â  Â  Â  emailInput.focus();
Â  Â  }

Â  Â  function hideAuthSection() {
Â  Â  Â  authSection.style.display = 'none';
Â  Â  Â  authContainer.style.opacity = 0;
Â  Â  Â  messageDiv.textContent = '';
        clearFieldErrors(); // Limpiar errores de campo al cerrar
Â  Â  Â  authForm.reset();
Â  Â  Â  isSubmitting = false;
Â  Â  Â  submitButton.disabled = false;
Â  Â  Â  submitButton.textContent = (mode === 'login') ? 'Iniciar sesiÃ³n' : 'Registrarse';
        // MEJORA FUNCIONAL 1: Resetear el tipo de input de password a 'password' al cerrar
        passwordInput.type = 'password';
        togglePasswordButton.textContent = 'ğŸ‘ï¸';
Â  Â  }

Â  Â  function setMode(newMode) {
Â  Â  Â  mode = newMode;
Â  Â  Â  messageDiv.textContent = '';
        clearFieldErrors(); // Limpiar errores de campo al cambiar modo
Â  Â  Â  authForm.reset();
Â  Â  Â  generatedEstablishmentID = null;

Â  Â  Â  const isLogin = mode === 'login';
Â  Â  Â  formTitle.textContent = isLogin ? 'Iniciar sesiÃ³n' : 'Registro';
Â  Â  Â  submitButton.textContent = isLogin ? 'Iniciar sesiÃ³n' : 'Registrarse';
Â  Â  Â  toggleSignupSpan.style.display = isLogin ? 'inline' : 'none';
Â  Â  Â  toggleSigninSpan.style.display = isLogin ? 'none' : 'inline';
Â  Â  Â  roleSelectionDiv.style.display = isLogin ? 'none' : 'flex';
Â  Â  Â  establishmentField.style.display = 'none';

Â  Â  Â  if (isLogin) {
Â  Â  Â  Â  roleJugadorRadio.removeAttribute('required');
Â  Â  Â  Â  roleEstablecimientoRadio.removeAttribute('required');
Â  Â  Â  Â  establishmentNameInput.removeAttribute('required');
Â  Â  Â  Â  passwordInput.setAttribute('autocomplete', 'current-password');
            // MEJORA FUNCIONAL 1: Asegurar tipo password en modo login por defecto
            passwordInput.type = 'password';
            togglePasswordButton.textContent = 'ğŸ‘ï¸';
Â  Â  Â  } else {
Â  Â  Â  Â  roleJugadorRadio.setAttribute('required', true);
Â  Â  Â  Â  roleEstablecimientoRadio.setAttribute('required', true);
Â  Â  Â  Â  passwordInput.setAttribute('autocomplete', 'new-password');
Â  Â  Â  Â  handleRoleChange();
Â  Â  Â  }
Â  Â  Â  isSubmitting = false;
Â  Â  Â  submitButton.disabled = false;
Â  Â  }

Â  Â  function handleRoleChange() {
Â  Â  Â  if (mode === 'signup') {
Â  Â  Â  Â  if (roleEstablecimientoRadio.checked) {
Â  Â  Â  Â  Â  establishmentField.style.display = 'flex';
Â  Â  Â  Â  Â  establishmentNameInput.setAttribute('required', true);
Â  Â  Â  Â  Â  if (!generatedEstablishmentID) {
Â  Â  Â  Â  Â  Â  generatedEstablishmentID = "EST-" + Math.floor(100000 + Math.random() * 900000);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  establishmentInput.value = generatedEstablishmentID;
             // MEJORA FUNCIONAL 2: Limpiar posible error previo al ocultar/mostrar
             establishmentNameErrorSpan.textContent = '';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  establishmentField.style.display = 'none';
Â  Â  Â  Â  Â  establishmentNameInput.removeAttribute('required');
Â  Â  Â  Â  Â  establishmentInput.value = '';
Â  Â  Â  Â  Â  establishmentNameInput.value = '';
             // MEJORA FUNCIONAL 2: Limpiar posible error previo al ocultar/mostrar
             establishmentNameErrorSpan.textContent = '';
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  function showMessage(text, isError = false) {
Â  Â  Â  messageDiv.textContent = text;
Â  Â  Â  messageDiv.style.color = isError ? 'var(--error-color)' : 'var(--success-color)';
Â  Â  Â  if (isError) {
Â  Â  Â  Â  authContainer.classList.add('shake');
Â  Â  Â  Â  setTimeout(() => authContainer.classList.remove('shake'), 500);
Â  Â  Â  } else {
Â  Â  Â  Â  Â authContainer.classList.remove('shake');
Â  Â  Â  }
Â  Â  }

    // MEJORA FUNCIONAL 3: FunciÃ³n para manejar el cierre de sesiÃ³n
    async function handleLogout() {
        try {
            const { error } = await supabaseClient.auth.signOut();
            if (error) throw error;
            console.log("Usuario cerrÃ³ sesiÃ³n.");
            // Redirigir al usuario a la pÃ¡gina de inicio o recargar
            window.location.href = "/"; // O "home.html" si esa es tu pÃ¡gina principal post-logout
        } catch (error) {
            console.error("Error al cerrar sesiÃ³n:", error);
            alert("Error al cerrar sesiÃ³n: " + error.message); // O mostrar en un div en la pÃ¡gina
        }
    }

    // MEJORA FUNCIONAL 3: FunciÃ³n para actualizar la visibilidad de los botones de la nav
    function updateNavAuthButtons(isLoggedIn) {
        if (isLoggedIn) {
            authButtonsContainer.classList.add('hidden');
            loggedInContainer.classList.remove('hidden');
        } else {
            authButtonsContainer.classList.remove('hidden');
            loggedInContainer.classList.add('hidden');
        }
         // En mÃ³vil, el display flex/none se maneja por .nav-right.mobile-nav-active
         // Pero ocultamos/mostramos los contenedores internos independientemente
         // El CSS ya maneja que si el padre es 'none', el hijo tambiÃ©n lo sea.
         // Aseguramos que la direcciÃ³n sea correcta segÃºn el estado mobile/desktop
         if (navRightContainer.classList.contains('mobile-nav-active')) {
             authButtonsContainer.style.flexDirection = 'column';
             loggedInContainer.style.flexDirection = 'column';
         } else {
             authButtonsContainer.style.flexDirection = 'row';
             loggedInContainer.style.flexDirection = 'row';
         }
    }


Â  Â  // === Event Listeners ===

    // MEJORA FUNCIONAL 2: Listeners para validaciÃ³n de campos al perder el foco
    emailInput.addEventListener('blur', () => {
        if (mode === 'signup' || emailInput.value.trim()) { // Validar en signup siempre, en login solo si no estÃ¡ vacÃ­o
             emailErrorSpan.textContent = validateEmail(emailInput.value);
        }
    });
    passwordInput.addEventListener('blur', () => {
         if (mode === 'signup' || passwordInput.value.trim()) { // Validar en signup siempre, en login solo si no estÃ¡ vacÃ­o
            passwordErrorSpan.textContent = validatePassword(passwordInput.value);
         }
    });
    establishmentNameInput.addEventListener('blur', () => {
        if (mode === 'signup' && roleEstablecimientoRadio.checked) {
            establishmentNameErrorSpan.textContent = validateEstablishmentName(establishmentNameInput.value);
        }
    });

    // MEJORA FUNCIONAL 2: Limpiar errores al escribir
    emailInput.addEventListener('input', () => emailErrorSpan.textContent = '');
    passwordInput.addEventListener('input', () => passwordErrorSpan.textContent = '');
    establishmentNameInput.addEventListener('input', () => establishmentNameErrorSpan.textContent = '');


Â  Â  authForm.addEventListener('submit', async (e) => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  if (isSubmitting) return;

Â  Â  Â  isSubmitting = true;
Â  Â  Â  submitButton.disabled = true;
Â  Â  Â  submitButton.textContent = 'Procesando...';
Â  Â  Â  messageDiv.textContent = ''; // Limpiar mensaje general
Â  Â  Â  authContainer.classList.remove('shake');
      clearFieldErrors(); // Limpiar errores de campo al intentar enviar

      // MEJORA FUNCIONAL 2: Validar formulario en cliente antes de enviar
      if (!validateForm()) {
          isSubmitting = false;
          submitButton.disabled = false;
          submitButton.textContent = (mode === 'login') ? 'Iniciar sesiÃ³n' : 'Registrarse';
          showMessage("Por favor, corrige los errores en el formulario.", true); // Mensaje general de que hay errores
          return; // Detener el proceso si hay errores de validaciÃ³n cliente
      }


Â  Â  Â  const emailVal = emailInput.value.trim();
Â  Â  Â  const passVal = passwordInput.value.trim();
Â  Â  Â  let didRedirect = false;

Â  Â  Â  try {
Â  Â  Â  Â  // --- MODO LOGIN ---
Â  Â  Â  Â  if (mode === 'login') {
Â  Â  Â  Â  Â  // La validaciÃ³n cliente ya verificÃ³ que email y pass no estÃ©n vacÃ­os
Â  Â  Â  Â  Â  console.log("[Login] Intentando iniciar sesiÃ³n...");

Â  Â  Â  Â  Â  const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
Â  Â  Â  Â  Â  Â  email: emailVal, password: passVal
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  if (signInError) throw signInError;

Â  Â  Â  Â  Â  const currentUser = signInData?.user || (await supabaseClient.auth.getUser())?.data?.user;
Â  Â  Â  Â  Â  if (!currentUser) throw new Error('No se pudo verificar la sesiÃ³n del usuario despuÃ©s del inicio de sesiÃ³n.');

Â  Â  Â  Â  Â  // MEJORA FUNCIONAL 3: Actualizar UI de la nav al loguearse
             updateNavAuthButtons(true);
             hideAuthSection(); // Cerrar modal

Â  Â  Â  Â  Â  showMessage('Inicio de sesiÃ³n exitoso. Verificando perfil...', false);
Â  Â  Â  Â  Â  console.log("[Login] Usuario logueado:", currentUser.id);

Â  Â  Â  Â  Â  // Esperar un breve momento para que el usuario vea el mensaje y la UI cambie
             await new Promise(resolve => setTimeout(resolve, 500));

Â  Â  Â  Â  Â  const { data: perfil, error: perfilError } = await supabaseClient
Â  Â  Â  Â  Â  Â  .from('perfiles')
Â  Â  Â  Â  Â  Â  .select("user_id, establishment_number, role") // TambiÃ©n obtener el rol explÃ­citamente si es necesario
Â  Â  Â  Â  Â  Â  .eq('user_id', currentUser.id)
Â  Â  Â  Â  Â  Â  .single();

Â  Â  Â  Â  Â  if (perfilError) {
Â  Â  Â  Â  Â  Â  console.error("[Login] Error al buscar perfil:", perfilError);
Â  Â  Â  Â  Â  Â  showMessage("Perfil no encontrado o error. IntÃ©ntalo de nuevo."); // Mostrar error general en el modal si falla la bÃºsqueda de perfil POST-LOGIN
Â  Â  Â  Â  Â  Â  // No redirigir automÃ¡ticamente si falla la bÃºsqueda de perfil post-login, dejar al usuario reintentar o contactar soporte
                 // Revertir el estado del botÃ³n y del submitting
                 isSubmitting = false;
                 submitButton.disabled = false;
                 submitButton.textContent = 'Iniciar sesiÃ³n';
                 // Mostrar el modal de nuevo si estaba oculto (podrÃ­a no ser necesario si ya fallÃ³ antes de hideAuthSection)
                 // showAuthSection('login'); // Opcional: reabrir modal con el error

Â  Â  Â  Â  Â  } else if (!perfil) {
Â  Â  Â  Â  Â  Â  Â console.warn("[Login] Perfil no encontrado para usuario:", currentUser.id);
Â  Â  Â  Â  Â  Â  Â showMessage("Perfil no encontrado. Contacta soporte si crees que es un error."); // Mostrar error general
                 // Revertir el estado del botÃ³n y del submitting
                 isSubmitting = false;
                 submitButton.disabled = false;
                 submitButton.textContent = 'Iniciar sesiÃ³n';

Â  Â  Â  Â  Â  } else {
                // RedirecciÃ³n basada en perfil
Â  Â  Â  Â  Â  Â  console.log("[Login] Perfil encontrado:", perfil);
Â  Â  Â  Â  Â  Â  if (perfil.establishment_number !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("[Login] Redirigiendo a establecimiento:", perfil.establishment_number);
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = `establecimiento.html?id=${encodeURIComponent(perfil.establishment_number)}`;
Â  Â  Â  Â  Â  Â  Â  Â  didRedirect = true;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("[Login] Redirigiendo a perfil.html");
                 // Asumimos que el perfil de Jugador no necesita el email en la URL si ya estamos logueados?
                 // El cÃ³digo original redirige a home.html para jugadores. Mantengamos eso para no perder funcionalidad.
                 // Si querÃ­as que fuera a perfil.html, cÃ¡mbialo aquÃ­:
                 // window.location.href = "perfil.html"; // PodrÃ­as obtener el user_id o email de la sesiÃ³n si es necesario en perfil.html
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "home.html"; // Mantener lÃ³gica original de redirecciÃ³n a home para jugador
Â  Â  Â  Â  Â  Â  Â  Â  didRedirect = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }


Â  Â  Â  Â  // --- MODO REGISTRO ---
Â  Â  Â  Â  } else { // mode === 'signup'
Â  Â  Â  Â  Â  Â  console.log("[Signup] Iniciando proceso de registro...");
              // La validaciÃ³n cliente ya verificÃ³ campos requeridos y formato
Â  Â  Â  Â  Â  Â  const selectedRoleElem = document.querySelector('input[name="user-role"]:checked');
              // validateForm ya chequeÃ³ selectedRoleElem

Â  Â  Â  Â  Â  Â  const selectedRole = selectedRoleElem.value;
Â  Â  Â  Â  Â  Â  console.log("[Signup] Rol seleccionado:", selectedRole);
Â  Â  Â  Â  Â  Â  let establishmentName = null;
Â  Â  Â  Â  Â  Â  let currentEstablishmentId = null;

Â  Â  Â  Â  Â  Â  if (selectedRole === 'establecimiento') {
Â  Â  Â  Â  Â  Â  Â  Â  establishmentName = establishmentNameInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  currentEstablishmentId = generatedEstablishmentID;
                 // validateForm ya chequeÃ³ establishmentName y currentEstablishmentId
Â  Â  Â  Â  Â  Â  Â  Â  console.log("[Signup] Datos establecimiento:", currentEstablishmentId, establishmentName);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 1. Crear usuario Auth
Â  Â  Â  Â  Â  Â  console.log("[Signup] Intentando crear usuario en Auth...");
Â  Â  Â  Â  Â  Â  const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
Â  Â  Â  Â  Â  Â  Â  Â  email: emailVal, password: passVal
                // Puedes aÃ±adir options si necesitas metadata del usuario inmediatamente
                // options: { data: { role: selectedRole, establishment_id: currentEstablishmentId } } // Esto podrÃ­a simplificar la inserciÃ³n del perfil, pero requiere configuraciÃ³n en Supabase
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (signUpError) throw signUpError;

Â  Â  Â  Â  Â  Â  const userId = signUpData.user?.id;
Â  Â  Â  Â  Â  Â  if (!userId) throw new Error('Registro fallido: No se obtuvo ID de usuario.');
Â  Â  Â  Â  Â  Â  console.log("[Signup] Usuario creado en Auth:", userId);

             // MEJORA FUNCIONAL 3: Actualizar UI de la nav al registrarse
             updateNavAuthButtons(true);
             hideAuthSection(); // Cerrar modal

Â  Â  Â  Â  Â  Â  // 2. Insertar perfil
Â  Â  Â  Â  Â  Â  console.log("[Signup] Intentando insertar perfil...");
Â  Â  Â  Â  Â  Â  const { error: perfilError } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  .from('perfiles')
Â  Â  Â  Â  Â  Â  Â  Â  .insert([{ user_id: userId, role: selectedRole, establishment_number: currentEstablishmentId }]);
Â  Â  Â  Â  Â  Â  if (perfilError) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("[Signup] Error insertando perfil:", perfilError);
Â  Â  Â  Â  Â  Â  Â  Â  // Considerar si eliminar el usuario Auth si falla la inserciÃ³n del perfil
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Error al guardar perfil: ${perfilError.message}. Registro incompleto.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  console.log("[Signup] Perfil insertado para:", userId);

Â  Â  Â  Â  Â  Â  // 3. Insertar establecimiento (si aplica)
Â  Â  Â  Â  Â  Â  if (selectedRole === 'establecimiento') {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("[Signup] Intentando insertar establecimiento...");
Â  Â  Â  Â  Â  Â  Â  Â  const { error: estabError } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('establishments')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{ id: currentEstablishmentId, name: establishmentName }]);
Â  Â  Â  Â  Â  Â  Â  Â  if (estabError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("[Signup] Error insertando establecimiento:", estabError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Considerar si eliminar el usuario Auth y el perfil si falla la inserciÃ³n del establecimiento
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Error al guardar establecimiento: ${estabError.message}. Registro incompleto.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â console.log("[Signup] Establecimiento insertado:", currentEstablishmentId);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- LÃ“GICA DE REDIRECCIÃ“N POST-REGISTRO ---
Â  Â  Â  Â  Â  Â  console.log("[Signup] Registro completo en DB. Preparando redirecciÃ³n...");
Â  Â  Â  Â  Â  Â  // MEJORA FUNCIONAL 3: Mensaje mÃ¡s especÃ­fico post-registro, especialmente si requiere confirmaciÃ³n de email
             showMessage('Registro exitoso. Por favor, verifica tu correo electrÃ³nico para activar tu cuenta.', false); // AÃ±adir instrucciÃ³n de verificaciÃ³n de email

Â  Â  Â  Â  Â  Â  // Pausa breve opcional para que el usuario vea el mensaje
Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 2000)); // Pausa un poco mÃ¡s para leer el mensaje de verificaciÃ³n

Â  Â  Â  Â  Â  Â  if (selectedRole === 'establecimiento') {
Â  Â  Â  Â  Â  Â  Â  Â  // Redirigir a establecimiento.html con ID
Â  Â  Â  Â  Â  Â  Â  Â  const redirectUrl = `establecimiento.html?id=${encodeURIComponent(currentEstablishmentId)}`;
Â  Â  Â  Â  Â  Â  Â  Â  console.log("[Signup] REDIRIGIENDO (Establecimiento) a:", redirectUrl);
Â  Â  Â  Â  Â  Â  Â  Â  didRedirect = true;
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = redirectUrl;
Â  Â  Â  Â  Â  Â  } else { // selectedRole === 'jugador'
Â  Â  Â  Â  Â  Â  Â  Â  // LÃ³gica original redirigÃ­a a home.html. Si perfil.html necesita email, cÃ¡mbialo aquÃ­.
                 // Manteniendo redirecciÃ³n a home.html para jugador post-registro, como estaba originalmente
Â  Â  Â  Â  Â  Â  Â  Â  const redirectUrl = `home.html`; // LÃ³gica original: redirige jugador post-registro a home.html
                 // Si quieres que vaya a perfil.html con email como parÃ¡metro (el cÃ³digo original modificado sugerÃ­a esto, pero el *tuyo* redirigÃ­a a home):
                 // const redirectUrl = `perfil.html?email=${encodeURIComponent(emailVal)}`;
Â  Â  Â  Â  Â  Â  Â  Â  console.log("[Signup] REDIRIGIENDO (Jugador) a:", redirectUrl);
Â  Â  Â  Â  Â  Â  Â  Â  didRedirect = true;
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = redirectUrl;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  console.log("[Signup] Comando window.location.href ejecutado.");
Â  Â  Â  Â  }

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  // ... (Manejo de errores de Supabase o errores internos) ...
Â  Â  Â  Â  Â  console.error(`Error en modo ${mode}:`, error);
Â  Â  Â  Â  Â  let userMessage = `Error: `;
Â  Â  Â  Â  Â  if (error.message) {
Â  Â  Â  Â  Â  Â  if (error.message.includes("Invalid login credentials")) userMessage = "Correo o contraseÃ±a incorrectos.";
Â  Â  Â  Â  Â  Â  else if (error.message.includes("User already registered")) userMessage = "Este correo electrÃ³nico ya estÃ¡ registrado.";
Â  Â  Â  Â  Â  Â  else if (error.message.includes("Password should be at least 6 characters")) userMessage = "La contraseÃ±a debe tener al menos 6 caracteres.";
Â  Â  Â  Â  Â  Â  else if (error.message.includes("Email not confirmed")) userMessage = "Por favor, confirma tu correo electrÃ³nico antes de iniciar sesiÃ³n.";
                // Errores de Supabase sobre constraints/policies irÃ­an aquÃ­
Â  Â  Â  Â  Â  Â  else userMessage += error.message;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  userMessage += "OcurriÃ³ un error inesperado.";
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  showMessage(userMessage, true); // Mostrar errores generales en el div principal de mensajes

Â  Â  Â  } finally {
Â  Â  Â  Â  Â  console.log("[Finally] Bloque finally alcanzado. didRedirect =", didRedirect);
Â  Â  Â  Â  Â  if (!didRedirect) {
Â  Â  Â  Â  Â  Â  Â  console.log("[Finally] No hubo redirecciÃ³n, rehabilitando botÃ³n.");
Â  Â  Â  Â  Â  Â  Â  isSubmitting = false;
Â  Â  Â  Â  Â  Â  Â  submitButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  submitButton.textContent = (mode === 'login') ? 'Iniciar sesiÃ³n' : 'Registrarse';
                 // Mantener el modal abierto si hubo un error que no causÃ³ redirecciÃ³n
                 authSection.style.display = 'flex';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â console.log("[Finally] RedirecciÃ³n iniciada, no se rehabilita el botÃ³n ni se muestra el modal.");
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

    // MEJORA FUNCIONAL 1: Event listener para el toggle de visibilidad de contraseÃ±a
    togglePasswordButton.addEventListener('click', () => {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        // Cambiar el icono
        togglePasswordButton.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ'; // Opcional: cambiar a un ojo tachado
        // Opcional: Cambiar aria-label
        togglePasswordButton.setAttribute('aria-label', type === 'password' ? 'Mostrar contraseÃ±a' : 'Ocultar contraseÃ±a');
    });


Â  Â  // --- Otros Listeners (sin cambios funcionales importantes) ---
Â  Â  roleJugadorRadio.addEventListener('change', handleRoleChange);
Â  Â  roleEstablecimientoRadio.addEventListener('change', handleRoleChange);
Â  Â  closeModalButton.addEventListener('click', hideAuthSection);

    // MEJORA FUNCIONAL 3: Listener para el botÃ³n de cerrar sesiÃ³n
    logoutButton.addEventListener('click', handleLogout);


Â  Â  hamburgerBtn.addEventListener('click', () => {
Â  Â  Â  const isExpanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
Â  Â  Â  hamburgerBtn.setAttribute('aria-expanded', !isExpanded);
Â  Â  Â  navRightContainer.classList.toggle('mobile-nav-active');
Â  Â  Â  hamburgerBtn.textContent = !isExpanded ? 'âœ•' : 'â˜°';
         // Asegurar que la direcciÃ³n de los elementos internos sea correcta al abrir/cerrar el menÃº mÃ³vil
         if (navRightContainer.classList.contains('mobile-nav-active')) {
             authButtonsContainer.style.flexDirection = 'column';
             loggedInContainer.style.flexDirection = 'column';
         } else {
              // Volver a la direcciÃ³n por defecto (fila, manejado por media query si estÃ¡ presente)
             authButtonsContainer.style.flexDirection = '';
             loggedInContainer.style.flexDirection = '';
         }
Â  Â  });

Â  Â  document.addEventListener('click', (event) => {
Â  Â  Â  const isClickInsideNav = navRightContainer.contains(event.target) || hamburgerBtn.contains(event.target);
Â  Â  Â  if (navRightContainer.classList.contains('mobile-nav-active') && !isClickInsideNav) {
Â  Â  Â  Â  hamburgerBtn.setAttribute('aria-expanded', 'false');
Â  Â  Â  Â  navRightContainer.classList.remove('mobile-nav-active');
Â  Â  Â  Â  hamburgerBtn.textContent = 'â˜°';
         // Asegurar que la direcciÃ³n de los elementos internos vuelva a ser correcta al cerrar el menÃº mÃ³vil
         authButtonsContainer.style.flexDirection = '';
         loggedInContainer.style.flexDirection = '';
Â  Â  Â  }
Â  Â  });

Â  Â  // === InicializaciÃ³n ===
Â  Â  window.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  const year = new Date().getFullYear();
Â  Â  Â  if (currentYearSpan) {
Â  Â  Â  Â  currentYearSpan.textContent = year; // Actualiza el aÃ±o dinÃ¡micamente
Â  Â  Â  } else {
Â  Â  Â  Â  console.warn("Elemento con id 'current-year' no encontrado para actualizar el aÃ±o.");
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  const { data: { session } } = await supabaseClient.auth.getSession();
Â  Â  Â  Â  // MEJORA FUNCIONAL 3: Actualizar botones de la nav al cargar la pÃ¡gina
             updateNavAuthButtons(session !== null);
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error al verificar sesiÃ³n:", error);
Â  Â  Â  Â  // Si hay error al verificar sesiÃ³n, asumir que no estÃ¡ logueado y mostrar botones de auth
Â  Â  Â  Â  updateNavAuthButtons(false);
Â  Â  Â  }
Â  Â  Â  setMode('signup'); // Iniciar en modo registro por defecto
Â  Â  });

    // Opcional: Supabase onAuthStateChange listener para reaccionar a cambios de auth globales (login en otra pestaÃ±a, etc.)
    // supabaseClient.auth.onAuthStateChange((event, session) => {
    //    console.log("Auth state changed:", event, session);
    //    // Puedes usar esto para actualizar la UI en tiempo real si no hay redirecciÃ³n inmediata
    //    updateNavAuthButtons(session !== null);
    //    // PodrÃ­as aÃ±adir lÃ³gica aquÃ­ para redirigir si se cierra la sesiÃ³n desde otro lado, etc.
    // });

Â  </script>
</body>
</html>