<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Catch Up Padel - Establecimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fuente moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Leaflet CSS (sin integridad para evitar bloqueos) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
  <style>
    /* Reset b谩sico */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* Estilos base */
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fff8f2 0%, #ffe9d9 100%);
      color: #333;
      padding: 1rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* Contenedor principal */
    .container {
      max-width: 800px;
      margin: auto;
      background-color: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    /* T铆tulo principal */
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #2c3e50;
      font-weight: 600;
    }
    /* Formulario */
    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #444;
    }
    input[type="text"],
    input[type="url"],
    input[type="number"],
    select {
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
      background-color: #f9f9f9;
    }
    /* L铆nea de direcci贸n */
    .address-line {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .address-line input,
    .address-line select {
      flex: 1;
      min-width: 100px;
    }
    /* Bot贸n para buscar en el mapa */
    .action-btn {
      align-self: flex-start;
      padding: 0.5rem 1rem;
      background-color: #ff9500;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }
    .action-btn:hover {
      background-color: #e07e00;
    }
    /* Mapa con Leaflet */
    #map {
      width: 100%;
      height: 300px;
      margin-top: 1rem;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    /* Botones de Grabar y Eliminar */
    .button-group {
      display: flex;
      justify-content: space-around;
      margin-top: 1rem;
      gap: 1rem;
    }
    .button-group button {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    .btn-save {
      background-color: #27ae60;
    }
    .btn-save:hover {
      background-color: #219150;
    }
    .btn-delete {
      background-color: #e74c3c;
    }
    .btn-delete:hover {
      background-color: #c0392b;
    }
    /* Grupo para URL + Bot贸n */
    .url-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .url-group input[type="url"] {
      flex: 1;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        margin-top: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
      }
      .address-line {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Crear Establecimiento</h1>
    <form id="establecimiento-form">
      <!-- Nombre del establecimiento -->
      <div class="form-group">
        <label for="nombre">Nombre del Establecimiento</label>
        <input type="text" id="nombre" name="nombre" placeholder="Ingresa el nombre" required>
      </div>

      <!-- ID 煤nico generado autom谩ticamente (solo lectura) -->
      <div class="form-group">
        <label for="uniqueId">ID nico (8 d铆gitos)</label>
        <input type="text" id="uniqueId" name="uniqueId" readonly>
      </div>

      <!-- L铆nea de direcci贸n: Pa铆s, Provincia, Localidad, Direcci贸n, C贸digo Postal -->
      <div class="form-group">
        <label>Direcci贸n Completa</label>
        <div class="address-line">
          <!-- Pa铆s (obligatorio) -->
          <select id="pais" name="pais" required>
            <option value="">Selecciona Pa铆s</option>
            <option value="Argentina"> Argentina</option>
            <option value="Espa帽a"> Espa帽a</option>
          </select>
          <!-- Provincia (obligatorio) -->
          <select id="provincia" name="provincia" required>
            <option value="">Selecciona Provincia</option>
          </select>
          <!-- Localidad (opcional) -->
          <input type="text" id="localidad" name="localidad" placeholder="Localidad">
          <!-- Direcci贸n (obligatorio) -->
          <input type="text" id="direccion" name="direccion" placeholder="Direcci贸n" required>
          <!-- C贸digo Postal (obligatorio) -->
          <input type="text" id="codigoPostal" name="codigoPostal" placeholder="C贸digo Postal" required>
        </div>
        <!-- Bot贸n para buscar en el mapa -->
        <button type="button" class="action-btn" onclick="buscarEnMapa()">Buscar en el mapa</button>
      </div>

      <!-- URL del lugar (con bot贸n para abrir) -->
      <div class="form-group">
        <label for="urlLugar">URL del Lugar</label>
        <div class="url-group">
          <input type="url" id="urlLugar" name="urlLugar" placeholder="http://...">
          <button type="button" class="action-btn" id="btn-open-url">Abrir</button>
        </div>
      </div>

      <!-- Direcci贸n de Instagram (con bot贸n para abrir) -->
      <div class="form-group">
        <label for="instagramUrl">Direcci贸n de Instagram</label>
        <div class="url-group">
          <input type="url" id="instagramUrl" name="instagramUrl" placeholder="https://instagram.com/tu-cuenta">
          <button type="button" class="action-btn" id="btn-open-ig">Abrir</button>
        </div>
      </div>

      <!-- Cantidad de canchas -->
      <div class="form-group">
        <label for="cantCanchas">Cantidad de Canchas</label>
        <input type="number" id="cantCanchas" name="cantCanchas" min="1" placeholder="Ej. 2" required>
      </div>

      <!-- Mapa: se actualizar谩 seg煤n la direcci贸n ingresada -->
      <div id="map"></div>

      <!-- Botones de Grabar y Eliminar -->
      <div class="button-group">
        <button type="submit" class="btn-save">Grabar</button>
        <button type="button" class="btn-delete" id="btn-delete">Eliminar</button>
      </div>
    </form>
  </div>

  <!-- Cargar Leaflet JS (sin integridad) -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Cargar Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Configuraci贸n de Supabase (reemplaza con tus credenciales reales)
    const SUPABASE_URL = 'https://idlvxinjfbsujpvxncbr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkbHZ4aW5qZmJzdWpwdnhuY2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE1NTgxMTMsImV4cCI6MjA1NzEzNDExM30.kojYn4tEbQJvafypVnq2TjF5JYCpFC7cBaKKk3qTkig';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Generar y asignar el ID 煤nico
    function generarUniqueId() {
      return Math.floor(10000000 + Math.random() * 90000000).toString();
    }
    document.getElementById("uniqueId").value = generarUniqueId();

    // Listas de provincias para cada pa铆s
    const provincias = {
      "Argentina": [
        "CABA", "Buenos Aires", "C贸rdoba", "Santa Fe", "Mendoza", "Tucum谩n",
        "Entre R铆os", "Salta", "Chaco", "Corrientes", "Misiones"
      ],
      "Espa帽a": [
        "Madrid", "Barcelona", "Valencia", "Sevilla", "Zaragoza", "M谩laga",
        "Murcia", "Bilbao", "Alicante", "Granada"
      ]
    };

    // Actualizar opciones de provincia seg煤n pa铆s
    function updateProvinceOptions() {
      const paisSelect = document.getElementById("pais");
      const provinciaSelect = document.getElementById("provincia");
      const selectedPais = paisSelect.value;
      provinciaSelect.innerHTML = '<option value="">Selecciona Provincia</option>';
      if (provincias[selectedPais]) {
        provincias[selectedPais].forEach(prov => {
          const option = document.createElement("option");
          option.value = prov;
          option.textContent = prov;
          provinciaSelect.appendChild(option);
        });
      }
    }
    document.getElementById("pais").addEventListener("change", updateProvinceOptions);

    // Inicializaci贸n del mapa con Leaflet
    let map = L.map('map').setView([-34.6037, -58.3816], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let marker;

    // Funci贸n para buscar en el mapa con fallback autom谩tico
    function buscarEnMapa() {
      // Intentamos primero con la b煤squeda detallada (todos los campos)
      const primeraDireccion = construirDireccionCompleta(true);
      console.log("B煤squeda detallada:", primeraDireccion);
      geocodeNominatim(primeraDireccion, (exito) => {
        // Si la b煤squeda detallada no devuelve resultado, se usa la reducida
        if (!exito) {
          const segundaDireccion = construirDireccionCompleta(false);
          console.log("B煤squeda reducida:", segundaDireccion);
          geocodeNominatim(segundaDireccion, (exito2) => {
            if (!exito2) {
              alert("No se encontr贸 la ubicaci贸n. Verifica que los datos sean correctos.");
            }
          });
        }
      });
    }

    // Construir la direcci贸n completa (usarTodo = true incluye localidad y CP)
    function construirDireccionCompleta(usarTodo) {
      const pais = document.getElementById("pais").value.trim();
      let provincia = document.getElementById("provincia").value.trim();
      let localidad = document.getElementById("localidad").value.trim();
      let direccion = document.getElementById("direccion").value.trim();
      let codigoPostal = document.getElementById("codigoPostal").value.trim();

      // Reemplazar "Ciudad de Buenos Aires" por "Buenos Aires" si fuera el caso (aqu铆 usamos CABA en la lista)
      if (provincia.toLowerCase() === "ciudad de buenos aires") {
        provincia = "Buenos Aires";
      }
      if (!usarTodo) {
        localidad = "";
        codigoPostal = "";
      }
      return `${direccion}${localidad ? ", " + localidad : ""}, ${provincia}, ${pais}${codigoPostal ? ", " + codigoPostal : ""}`;
    }

    // Funci贸n para geocodificar usando Nominatim
    function geocodeNominatim(direccionCompleta, callback) {
      if (!direccionCompleta) {
        callback(false);
        return;
      }
      fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(direccionCompleta)}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            map.setView([lat, lon], 15);
            if (marker) {
              marker.setLatLng([lat, lon]);
            } else {
              marker = L.marker([lat, lon]).addTo(map);
            }
            callback(true);
          } else {
            console.error("No se encontr贸 la ubicaci贸n para:", direccionCompleta);
            callback(false);
          }
        })
        .catch(error => {
          console.error("Error al geocodificar:", error);
          callback(false);
        });
    }

    // Bot贸n para abrir la URL del lugar
    document.getElementById("btn-open-url").addEventListener("click", function() {
      const urlLugar = document.getElementById("urlLugar").value.trim();
      if (urlLugar) {
        window.open(urlLugar, "_blank");
      } else {
        alert("No se ha especificado ninguna URL.");
      }
    });

    // Bot贸n para abrir la URL de Instagram
    document.getElementById("btn-open-ig").addEventListener("click", function() {
      const igUrl = document.getElementById("instagramUrl").value.trim();
      if (igUrl) {
        window.open(igUrl, "_blank");
      } else {
        alert("No se ha especificado ninguna direcci贸n de Instagram.");
      }
    });

    // Manejo del env铆o del formulario: insertar en Supabase
    document.getElementById("establecimiento-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      // Recopilar datos del formulario
      const id = document.getElementById("uniqueId").value.trim();
      const name = document.getElementById("nombre").value.trim();
      const country = document.getElementById("pais").value.trim();
      const province = document.getElementById("provincia").value.trim();
      const locality = document.getElementById("localidad").value.trim();
      const address = document.getElementById("direccion").value.trim();
      const postal_code = document.getElementById("codigoPostal").value.trim();
      const url = document.getElementById("urlLugar").value.trim();
      const instagram_url = document.getElementById("instagramUrl").value.trim();
      const court_count = parseInt(document.getElementById("cantCanchas").value.trim(), 10);

      // Opcional: obtener latitud y longitud si se ha realizado la b煤squeda
      let latitude = null;
      let longitude = null;
      if (marker) {
        const latlng = marker.getLatLng();
        latitude = latlng.lat;
        longitude = latlng.lng;
      }

      // Insertar en la tabla "establishments"
      const { data, error } = await supabaseClient
        .from('establishments')
        .insert([
          {
            id,
            name,
            country,
            province,
            locality: locality || null,
            address,
            postal_code,
            url: url || null,
            instagram_url: instagram_url || null,
            court_count,
            latitude,
            longitude
          }
        ]);

      if (error) {
        console.error("Error al guardar establecimiento:", error.message);
        alert("Error al guardar establecimiento: " + error.message);
      } else {
        alert("Establecimiento guardado exitosamente.");
        // Opcional: limpiar el formulario o redirigir
      }
    });

    // Manejo del bot贸n Eliminar
    document.getElementById("btn-delete").addEventListener("click", function() {
      if (confirm("驴Est谩s seguro de eliminar este establecimiento?")) {
        alert("Establecimiento eliminado.");
        // Aqu铆 implementar铆as la l贸gica de borrado en Supabase si es necesario
      }
    });
  </script>
</body>
</html>
