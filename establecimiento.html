<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Catch Up Padel - Establecimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fuente moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Leaflet CSS (sin integridad para evitar bloqueos) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
  <style>
    /* Reset b√°sico */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    /* Estilos base */
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fff8f2 0%, #ffe9d9 100%);
      color: #333;
      padding: 1rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* Contenedor principal */
    .container {
      max-width: 800px;
      margin: auto;
      background-color: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    /* T√≠tulo principal */
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #2c3e50;
      font-weight: 600;
    }
    /* Formulario */
    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: 600; margin-bottom: 0.5rem; color: #444; }
    input[type="text"],
    input[type="url"],
    input[type="number"],
    select {
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
      background-color: #f9f9f9;
    }
    /* L√≠nea de direcci√≥n */
    .address-line {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .address-line input,
    .address-line select { flex: 1; min-width: 100px; }
    /* Bot√≥n para buscar en el mapa */
    .action-btn {
      align-self: flex-start;
      padding: 0.5rem 1rem;
      background-color: #ff9500;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }
    .action-btn:hover { background-color: #e07e00; }
    /* Mapa con Leaflet */
    #map {
      width: 100%;
      height: 300px;
      margin-top: 1rem;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    /* Botones de Grabar y Eliminar */
    .button-group {
      display: flex;
      justify-content: space-around;
      margin-top: 1rem;
      gap: 1rem;
    }
    .button-group button {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    .btn-save { background-color: #27ae60; }
    .btn-save:hover { background-color: #219150; }
    .btn-delete { background-color: #e74c3c; }
    .btn-delete:hover { background-color: #c0392b; }
    /* Grupo para URL + Bot√≥n */
    .url-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .url-group input[type="url"] { flex: 1; }
    /* Responsive */
    @media (max-width: 768px) {
      .container { margin-top: 1rem; margin-bottom: 1rem; padding: 1rem; }
      .address-line { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Crear Establecimiento</h1>
    <form id="establecimiento-form">
      <!-- Nombre del establecimiento -->
      <div class="form-group">
        <label for="nombre">Nombre del Establecimiento</label>
        <input type="text" id="nombre" name="nombre" placeholder="Ingresa el nombre" required>
      </div>
      <!-- ID √∫nico generado autom√°ticamente (solo lectura) -->
      <div class="form-group">
        <label for="uniqueId">ID √önico (8 d√≠gitos)</label>
        <input type="text" id="uniqueId" name="uniqueId" readonly>
      </div>
      <!-- L√≠nea de direcci√≥n: Pa√≠s, Provincia, Localidad, Direcci√≥n, C√≥digo Postal -->
      <div class="form-group">
        <label>Direcci√≥n Completa</label>
        <div class="address-line">
          <select id="pais" name="pais" required>
            <option value="">Selecciona Pa√≠s</option>
            <option value="Argentina">üá¶üá∑ Argentina</option>
            <option value="Espa√±a">üá™üá∏ Espa√±a</option>
          </select>
          <select id="provincia" name="provincia" required>
            <option value="">Selecciona Provincia</option>
          </select>
          <input type="text" id="localidad" name="localidad" placeholder="Localidad">
          <input type="text" id="direccion" name="direccion" placeholder="Direcci√≥n" required>
          <input type="text" id="codigoPostal" name="codigoPostal" placeholder="C√≥digo Postal" required>
        </div>
        <button type="button" class="action-btn" onclick="buscarEnMapa()">Buscar en el mapa</button>
      </div>
      <!-- URL del lugar (con bot√≥n para abrir) -->
      <div class="form-group">
        <label for="urlLugar">URL del Lugar</label>
        <div class="url-group">
          <input type="url" id="urlLugar" name="urlLugar" placeholder="http://...">
          <button type="button" class="action-btn" id="btn-open-url">Abrir</button>
        </div>
      </div>
      <!-- Direcci√≥n de Instagram (con bot√≥n para abrir) -->
      <div class="form-group">
        <label for="instagramUrl">Direcci√≥n de Instagram</label>
        <div class="url-group">
          <input type="url" id="instagramUrl" name="instagramUrl" placeholder="https://instagram.com/tu-cuenta">
          <button type="button" class="action-btn" id="btn-open-ig">Abrir</button>
        </div>
      </div>
      <!-- Cantidad de canchas -->
      <div class="form-group">
        <label for="cantCanchas">Cantidad de Canchas</label>
        <input type="number" id="cantCanchas" name="cantCanchas" min="1" placeholder="Ej. 2" required>
      </div>
      <!-- Mapa -->
      <div id="map"></div>
      <!-- Botones de Grabar y Eliminar -->
      <div class="button-group">
        <button type="submit" class="btn-save">Grabar</button>
        <button type="button" class="btn-delete" id="btn-delete">Eliminar</button>
      </div>
    </form>
  </div>

  <!-- Leaflet JS (sin integridad) -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Configuraci√≥n de Supabase ‚Äì reemplaza con tus credenciales reales
    const SUPABASE_URL = 'https://idlvxinjfbsujpvxncbr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkbHZ4aW5qZmJzdWpwdnhuY2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE1NTgxMTMsImV4cCI6MjA1NzEzNDExM30.kojYn4tEbQJvafypVnq2TjF5JYCpFC7cBaKKk3qTkig';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Generar y asignar ID √∫nico
    function generarUniqueId() {
      return Math.floor(10000000 + Math.random() * 90000000).toString();
    }
    document.getElementById("uniqueId").value = generarUniqueId();

    // Opciones de provincias
    const provincias = {
      "Argentina": [
        "CABA", "Buenos Aires", "C√≥rdoba", "Santa Fe", "Mendoza", "Tucum√°n",
        "Entre R√≠os", "Salta", "Chaco", "Corrientes", "Misiones"
      ],
      "Espa√±a": [
        "Madrid", "Barcelona", "Valencia", "Sevilla", "Zaragoza", "M√°laga",
        "Murcia", "Bilbao", "Alicante", "Granada"
      ]
    };

    // Actualizar opciones de provincia seg√∫n pa√≠s
    function updateProvinceOptions() {
      const paisSelect = document.getElementById("pais");
      const provinciaSelect = document.getElementById("provincia");
      const selectedPais = paisSelect.value;
      provinciaSelect.innerHTML = '<option value="">Selecciona Provincia</option>';
      if (provincias[selectedPais]) {
        provincias[selectedPais].forEach(prov => {
          const option = document.createElement("option");
          option.value = prov;
          option.textContent = prov;
          provinciaSelect.appendChild(option);
        });
      }
    }
    document.getElementById("pais").addEventListener("change", updateProvinceOptions);

    // Inicializaci√≥n del mapa con Leaflet
    let map = L.map('map').setView([-34.6037, -58.3816], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let marker;

    // Funci√≥n para buscar en el mapa con fallback autom√°tico
    function buscarEnMapa() {
      // Intentamos primero con la b√∫squeda completa (todos los campos)
      const primeraDireccion = construirDireccionCompleta(true);
      console.log("B√∫squeda detallada:", primeraDireccion);
      geocodeNominatim(primeraDireccion, (exito) => {
        if (!exito) {
          // Si la primera b√∫squeda no tuvo √©xito, probar con una b√∫squeda reducida
          const segundaDireccion = construirDireccionCompleta(false);
          console.log("B√∫squeda reducida:", segundaDireccion);
          geocodeNominatim(segundaDireccion, (exito2) => {
            if (!exito2) {
              alert("No se encontr√≥ la ubicaci√≥n. Verifica que los datos sean correctos.");
            }
          });
        }
      });
    }

    // Construir la direcci√≥n completa
    function construirDireccionCompleta(usarTodo) {
      const pais = document.getElementById("pais").value.trim();
      let provincia = document.getElementById("provincia").value.trim();
      let localidad = document.getElementById("localidad").value.trim();
      let direccion = document.getElementById("direccion").value.trim();
      let codigoPostal = document.getElementById("codigoPostal").value.trim();

      // Si provincia es "Ciudad de Buenos Aires", se reemplaza por "Buenos Aires"
      if (provincia.toLowerCase() === "ciudad de buenos aires") {
        provincia = "Buenos Aires";
      }
      if (!usarTodo) {
        localidad = "";
        codigoPostal = "";
      }
      return `${direccion}${localidad ? ", " + localidad : ""}, ${provincia}, ${pais}${codigoPostal ? ", " + codigoPostal : ""}`;
    }

    // Geocodificar con Nominatim
    function geocodeNominatim(direccionCompleta, callback) {
      if (!direccionCompleta) { callback(false); return; }
      fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(direccionCompleta)}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            map.setView([lat, lon], 15);
            if (marker) {
              marker.setLatLng([lat, lon]);
            } else {
              marker = L.marker([lat, lon]).addTo(map);
            }
            callback(true);
          } else {
            console.error("No se encontr√≥ la ubicaci√≥n para:", direccionCompleta);
            callback(false);
          }
        })
        .catch(error => {
          console.error("Error al geocodificar:", error);
          callback(false);
        });
    }

    // Bot√≥n para abrir URL del lugar
    document.getElementById("btn-open-url").addEventListener("click", function() {
      const urlLugar = document.getElementById("urlLugar").value.trim();
      if (urlLugar) { window.open(urlLugar, "_blank"); }
      else { alert("No se ha especificado ninguna URL."); }
    });

    // Bot√≥n para abrir URL de Instagram
    document.getElementById("btn-open-ig").addEventListener("click", function() {
      const igUrl = document.getElementById("instagramUrl").value.trim();
      if (igUrl) { window.open(igUrl, "_blank"); }
      else { alert("No se ha especificado ninguna direcci√≥n de Instagram."); }
    });

    // Manejo del env√≠o del formulario: Insertar en Supabase
    document.getElementById("establecimiento-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      // Recopilar datos del formulario
      const id = document.getElementById("uniqueId").value.trim();
      const name = document.getElementById("nombre").value.trim();
      const country = document.getElementById("pais").value.trim();
      const province = document.getElementById("provincia").value.trim();
      const locality = document.getElementById("localidad").value.trim();
      const address = document.getElementById("direccion").value.trim();
      const postal_code = document.getElementById("codigoPostal").value.trim();
      const url = document.getElementById("urlLugar").value.trim();
      const instagram_url = document.getElementById("instagramUrl").value.trim();
      const court_count = parseInt(document.getElementById("cantCanchas").value.trim(), 10);

      // Obtener latitud y longitud si se realiz√≥ una b√∫squeda
      let latitude = null, longitude = null;
      if (marker) {
        const latlng = marker.getLatLng();
        latitude = latlng.lat;
        longitude = latlng.lng;
      }
      
      // Depurar valores a insertar
      console.log("Insertando establecimiento con valores:", {
        id, name, country, province, locality, address, postal_code, url, instagram_url, court_count, latitude, longitude
      });
      
      try {
        const { data, error } = await supabaseClient
          .from('establishments')
          .insert([
            {
              id,
              name,
              country,
              province,
              locality: locality || null,
              address,
              postal_code,
              url: url || null,
              instagram_url: instagram_url || null,
              court_count,
              latitude,
              longitude
            }
          ]);
        if (error) {
          console.error("Error al guardar establecimiento:", error);
          alert("Error al guardar establecimiento: " + error.message);
        } else {
          console.log("Respuesta de inserci√≥n:", data);
          alert("Establecimiento guardado exitosamente.");
          // Opcional: limpiar formulario o redirigir
        }
      } catch (err) {
        console.error("Excepci√≥n al guardar establecimiento:", err);
        alert("Excepci√≥n al guardar establecimiento: " + err.message);
      }
    });

    // Bot√≥n para Eliminar (ejemplo)
    document.getElementById("btn-delete").addEventListener("click", function() {
      if (confirm("¬øEst√°s seguro de eliminar este establecimiento?")) {
        alert("Establecimiento eliminado.");
        // Implementa aqu√≠ la l√≥gica de borrado si es necesario.
      }
    });
  </script>
</body>
</html>
