<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Catch Up Padel - Crear Partido</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Time‑picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/dmuy/MDTimePicker/mdtimepicker.css">

    <!-- jQuery & mdtimepicker -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dmuy/MDTimePicker/mdtimepicker.js"></script>

    <style>
        /* (Igual que tu CSS original) */
        :root {
            --color-primario:#FFA726;
            --color-secundario:#FFB74D;
            --color-fondo:#FFF;
            --color-texto:#333;
            --color-hover:#777;
            --color-input-focus:rgba(255,167,38,.2);
            --color-borde:#ddd;
            --color-acento:#FF5722;
            --font-principal:'Poppins',sans-serif;
            --font-titulo:'Playfair Display',serif;
            --font-general:'Roboto',sans-serif;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        html{scroll-behavior:smooth;}
        body{font-family:var(--font-general);background:linear-gradient(135deg,#FFE0B2 0%,#FFCC80 100%);color:var(--color-texto);line-height:1.6;min-height:100vh;display:flex;flex-direction:column;}
        a{text-decoration:none;color:inherit;transition:color .3s ease-in-out;}a:hover{color:var(--color-primario);}
        header{background-color:rgba(255,255,255,.9);backdrop-filter:blur(10px);padding:1.5rem 2rem;box-shadow:0 4px 12px rgba(0,0,0,.08);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;flex-wrap:wrap;}
        header .logo{font-family:var(--font-titulo);font-size:2.5rem;font-weight:600;color:var(--color-primario);display:flex;align-items:center;transition:transform .3s ease-in-out;}
        header .logo i{margin-right:.5rem;font-size:1.2em;color:var(--color-acento);}header .logo:hover{transform:scale(1.03);}
        header nav a{font-size:1.1rem;padding:.75rem 1.5rem;background-color:var(--color-acento);color:#fff;border-radius:8px;font-weight:500;transition:background-color .3s ease-in-out,transform .2s ease-in-out;box-shadow:0 2px 6px rgba(0,0,0,.1);}header nav a:hover{background-color:var(--color-primario);transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.15);}
        .container{max-width:900px;width:95%;margin:3rem auto;background-color:var(--color-fondo);padding:2.5rem;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.1);animation:fadeInput .6s ease forwards;opacity:0;border:1px solid var(--color-acento);}@keyframes fadeInput{0%{opacity:0;transform:translateY(20px);}100%{opacity:1;transform:translateY(0);}}
        h1{text-align:center;margin-bottom:2rem;font-family:var(--font-titulo);font-size:2.8rem;color:var(--color-primario);letter-spacing:.8px;}
        hr{margin:2.5rem 0;border:none;border-top:1px solid var(--color-borde);}
        fieldset{border:2px solid var(--color-primario);border-radius:15px;padding:2rem;margin-bottom:2rem;background-color:#f9f9f9;box-shadow:0 4px 10px rgba(0,0,0,.05);transition:box-shadow .3s ease-in-out;}fieldset:hover{box-shadow:0 6px 14px rgba(0,0,0,.07);}legend{font-weight:bold;padding:0 15px;color:var(--color-primario);font-family:var(--font-principal);font-size:1.3rem;border-bottom:2px solid var(--color-primario);margin-bottom:1.2rem;display:inline-block;}
        .form-group{margin-bottom:1.8rem;}label{display:block;margin-bottom:.7rem;font-weight:600;color:var(--color-primario);font-size:1.1rem;}
        input[type="text"],input[type="date"],input[type="number"],select{width:100%;padding:1.2rem;border:1px solid var(--color-borde);border-radius:10px;font-size:1rem;transition:border-color .3s ease-in-out,box-shadow .3s ease-in-out;background-color:#fff;}input:disabled{background-color:#eee;cursor:not-allowed;}input:hover,select:hover{border-color:var(--color-acento);}input:focus,select:focus{outline:none;border-color:var(--color-acento);box-shadow:0 0 8px var(--color-input-focus);}
        .radio-group{display:flex;gap:2.5rem;margin-top:1rem;}.radio-group label{display:flex;align-items:center;cursor:pointer;font-weight:normal;}.radio-group input[type="radio"]{appearance:none;width:20px;height:20px;border:2px solid var(--color-acento);border-radius:50%;margin-right:.7rem;cursor:pointer;transition:background-color .2s ease-in-out;}.radio-group input[type="radio"]:checked{background-color:var(--color-acento);} .radio-group input[type="radio"]:checked::before{content:'';display:block;width:12px;height:12px;border-radius:50%;background-color:#fff;margin:4px;}
        .btn{display:inline-block;padding:1.2rem 2.5rem;border:none;border-radius:12px;background-color:var(--color-primario);color:#fff;font-size:1.15rem;cursor:pointer;transition:background-color .3s ease-in-out,transform .2s ease-in-out,box-shadow .3s ease-in-out;margin-top:2rem;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.12);} .btn:hover{background-color:var(--color-acento);transform:translateY(-3px);box-shadow:0 6px 14px rgba(0,0,0,.15);} .btn-schedule{margin-left:1.5rem;}
        .btn-primary{background-color:var(--color-primario);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;font-size:1rem;transition:background-color .3s ease;margin-top:1rem;} .btn-primary:hover{background-color:var(--color-acento);}
        .schedule-section select{max-width:200px;padding:1rem;border-radius:10px;border:1px solid var(--color-borde);font-size:1rem;}
        #scheduledList{margin-top:2rem;font-size:1rem;color:var(--color-hover);border-top:1px dashed var(--color-borde);padding-top:2rem;}#scheduledList ul{list-style:none;padding-left:0;}#scheduledList li{padding:.7rem 0;border-bottom:1px dashed var(--color-borde);}#scheduledList li:last-child{border-bottom:none;}
        .join-section{text-align:center;margin-top:3.5rem;padding:2.5rem;background-color:#f9f9f9;border-radius:15px;box-shadow:0 4px 10px rgba(0,0,0,.05);} .join-section h2{font-family:var(--font-titulo);color:var(--color-acento);margin-bottom:1.5rem;font-size:2rem;}
        .join-progress{margin:2rem auto;max-width:400px;border-radius:12px;overflow:hidden;border:2px solid var(--color-primario);}progress{width:100%;height:30px;appearance:none;border-radius:12px;}progress::-webkit-progress-bar{background-color:#eee;border-radius:12px;}progress::-webkit-progress-value{background-color:var(--color-primario);border-radius:12px;}
        .join-info{margin-top:20px;font-size:1.2rem;color:var(--color-primario);font-weight:bold;}
        .schedule-section-disabled{opacity:.6;pointer-events:none;}
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="logo"><i class="fas fa-racket"></i>Catch Up Padel</div>
        <nav><a href="home.html"><i class="fas fa-home"></i> Volver a Home</a></nav>
    </header>

    <!-- MAIN -->
    <div class="container">
        <h1><i class="fas fa-play-circle"></i> Crear Partido de Padel</h1>
        <form id="match-form">
            <!-- DATOS DEL PARTIDO -->
            <fieldset>
                <legend><i class="far fa-calendar-alt"></i> Datos del Partido</legend>
                <div class="form-group">
                    <label for="matchName"><i class="fas fa-signature"></i> Nombre del Partido</label>
                    <input type="text" id="matchName" placeholder="Ej. Torneo de Verano" required>
                </div>
                <div class="form-group">
                    <label for="matchDate"><i class="fas fa-calendar-day"></i> Fecha del Partido</label>
                    <input type="date" id="matchDate" required>
                </div>
                <div class="form-group">
                    <label for="startTime"><i class="far fa-clock"></i> Hora de Inicio</label>
                    <input type="text" id="startTime" placeholder="Selecciona la hora" required>
                </div>
                <div class="form-group duration-group">
                    <label for="durationMinutes"><i class="fas fa-hourglass-half"></i> Duración (minutos)</label>
                    <input type="number" id="durationMinutes" placeholder="Ej. 90" min="0" max="180" step="1" list="durationOptions">
                    <datalist id="durationOptions">
                        <option value="30"><option value="60"><option value="90"><option value="120"><option value="150"><option value="180">
                    </datalist>
                    <div id="durationDisplay">90 minutos</div>
                </div>
                <div class="form-group">
                    <label for="endTime"><i class="far fa-clock"></i> Hora de Fin</label>
                    <input type="text" id="endTime" placeholder="Calculado automáticamente" disabled>
                </div>
            </fieldset>

            <!-- ORGANIZADOR -->
            <fieldset>
                <legend><i class="fas fa-user-tie"></i> Datos del Organizador</legend>
                <div class="form-group">
                    <label for="organizer"><i class="fas fa-user"></i> Organizador</label>
                    <input type="text" id="organizer" readonly>
                </div>
            </fieldset>

            <!-- DETALLES -->  
            <fieldset>
                <legend><i class="fas fa-info-circle"></i> Detalles del Partido</legend>
                <div class="form-group">
                    <label><i class="fas fa-users"></i> Cantidad de Jugadores</label>
                    <div class="radio-group">
                        <label><input type="radio" name="playerCount" value="2" required> 2 jugadores</label>
                        <label><input type="radio" name="playerCount" value="4" required> 4 jugadores</label>
                        <label><input type="radio" name="playerCount" value="6" required> 6 jugadores</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="canchaSelect"><i class="fas fa-map-marker-alt"></i> Cancha</label>
                    <select id="canchaSelect" required>
                        <option value="">Seleccione una cancha</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pistaSelect"><i class="fas fa-map-pin"></i> Pista</label>
                    <select id="pistaSelect" required>
                        <option value="">Seleccione una pista</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="matchLevel"><i class="fas fa-signal"></i> Nivel del Partido</label>
                    <select id="matchLevel" required>
                        <option value="">Seleccione el nivel del partido</option>
                        <option value="Principiante">Principiante</option>
                        <option value="Intermedios">Intermedios</option>
                        <option value="Avanzados">Avanzados</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="teamType"><i class="fas fa-venus-mars"></i> Tipo de Parejas</label>
                    <select id="teamType" required>
                        <option value="">Seleccione el tipo de parejas</option>
                        <option value="Femenino">Femenino</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Mixto">Mixto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="completitud"><i class="fas fa-check-double"></i> Completitud</label>
                    <input type="text" id="completitud" value="Parcial (faltan 0)" readonly>
                </div>
            </fieldset>

            <button type="submit" id="btn-create" class="btn btn-create" style="margin-bottom:1rem;"><i class="fas fa-plus-circle"></i> Crear Partido</button>

            <!-- PROGRAMAR PARTIDOS -->
            <fieldset class="schedule-section schedule-section-disabled">
                <legend><i class="fas fa-calendar-week"></i> Programar Partidos</legend>
                <div class="form-group">
                    <label for="repeatWeeks"><i class="fas fa-redo"></i> Repetir partido durante (semanas):</label>
                    <select id="repeatWeeks">
                        <option value="0">No repetir</option>
                        <script>for(let i=1;i<=12;i++){document.write(`<option value="${i}">${i} semana${i>1?'s':''}</option>`);}<\/script>
                    </select>
                    <button type="button" id="btn-schedule" class="btn btn-schedule" disabled><i class="fas fa-calendar-plus"></i> Programar Partidos</button>
                </div>
                <div id="scheduledList"></div>
                <button type="button" id="btn-save-scheduled" class="btn btn-primary" style="margin-top:1rem;display:none;"><i class="fas fa-save"></i> Grabar Programación</button>
            </fieldset>

            <hr>

            <!-- UNIRSE AL PARTIDO -->
            <div class="join-section">
                <h2><i class="fas fa-handshake"></i> Unirse al Partido</h2>
                <button type="button" id="btn-join" class="btn btn-join"><i class="fas fa-user-plus"></i> Unirse al Partido</button>
                <div class="join-progress">
                    <progress id="joinProgress" value="0" max="1"></progress>
                    <div class="join-info" id="joinInfo">0 jugadores unidos / 0 necesarios</div>
                </div>
            </div>
        </form>
    </div>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script>
        /*************************************************
         *  UTILIDADES                                 *
         *************************************************/
        function generatePartyId(){ return (Math.floor(10000 + Math.random()*90000)).toString(); }
        function getLocalDate(isoDate){
            const [y,m,d] = isoDate.split('-').map(Number);
            return new Date(y, m-1, d, 12, 0, 0, 0);
        }

        /*************************************************
         *  INICIALIZAR TIMEPICKER                      *
         *************************************************/
        $(document).ready(function(){
            $('#startTime').mdtimepicker({is24hour:true,format:'hh:mm',theme:'blue',readOnly:true})
                .on('change', recalcEndTime);
        });

        /*************************************************
         *  SUPABASE INIT                               *
         *************************************************/
        const SUPABASE_URL    = 'https://idlvxinjfbsujpvxncbr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGci...'; // tu anon key
        const supabaseClient  = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentMatchId = null;
        let loggedUser     = null;

        /*************************************************
         *  CARGAR ORGANIZADOR                          *
         *************************************************/
        async function loadOrganizer(){
            const { data:{ session }, error } = await supabaseClient.auth.getSession();
            if(session?.user){
                const { data: profile } = await supabaseClient
                    .from('profiles').select('full_name').eq('id', session.user.id).single();
                const name = profile?.full_name || session.user.email;
                document.getElementById('organizer').value = name;
                loggedUser = { id: session.user.id, name };
            }
        }
        loadOrganizer();

        /*************************************************
         *  CARGAR CANCHAS Y PISTAS                     *
         *************************************************/
        async function loadCanchas(){
            const { data, error } = await supabaseClient.from('establishments').select('id,name');
            if(!error){
                const sel = document.getElementById('canchaSelect');
                data.forEach(c => sel.appendChild(new Option(c.name, c.id)));
            }
        }
        loadCanchas();

        document.getElementById('canchaSelect').addEventListener('change', async function(){
            const pistaSel = document.getElementById('pistaSelect');
            pistaSel.innerHTML = '<option value="">Seleccione una pista</option>';
            if(this.value){
                const { data } = await supabaseClient
                    .from('pistas').select('id,court_name').eq('establishment_id', this.value);
                data.forEach(p => pistaSel.appendChild(new Option(p.court_name, p.id)));
            }
        });

        /*************************************************
         *  CARGAR PARTIDO EXISTENTE                     *
         *************************************************/
        async function loadMatch(){
            const { data:{ session } } = await supabaseClient.auth.getSession();
            if(session?.user){
                const { data: match } = await supabaseClient
                    .from('partidos').select('*').eq('organizer', session.user.email).maybeSingle();
                if(match){
                    currentMatchId = match.id;
                    document.getElementById('matchName').value    = match.match_name;
                    document.getElementById('matchDate').value    = match.match_date;
                    $('#startTime').val(match.start_time);
                    $('#endTime').val(match.end_time);
                    document.querySelector(`input[name="playerCount"][value="${match.player_count}"]`).checked = true;
                    document.getElementById('canchaSelect').value = match.cancha_id;
                    document.getElementById('canchaSelect').dispatchEvent(new Event('change'));
                    setTimeout(()=>document.getElementById('pistaSelect').value = match.pista_id, 500);
                    document.getElementById('matchLevel').value   = match.match_level;
                    document.getElementById('teamType').value     = match.team_type;
                    document.getElementById('completitud').value  = match.completitud;
                    document.getElementById('btn-create').textContent = 'Modificar Partido';
                    document.querySelector('.schedule-section').classList.remove('schedule-section-disabled');
                    document.getElementById('btn-schedule').disabled = false;
                }
            }
        }
        loadMatch();

        /*************************************************
         *  CREAR / MODIFICAR PARTIDO                   *
         *************************************************/
        document.getElementById('match-form').addEventListener('submit', async function(e){
            e.preventDefault();
            const matchId = currentMatchId || generatePartyId();
            const dataObj = {
                id:           matchId,
                match_name:   document.getElementById('matchName').value.trim(),
                match_date:   document.getElementById('matchDate').value,
                start_time:   document.getElementById('startTime').value,
                end_time:     document.getElementById('endTime').value,
                organizer:    document.getElementById('organizer').value,
                player_count: +document.querySelector('input[name="playerCount"]:checked').value,
                cancha_id:    document.getElementById('canchaSelect').value,
                pista_id:     document.getElementById('pistaSelect').value,
                match_level:  document.getElementById('matchLevel').value,
                team_type:    document.getElementById('teamType').value,
                completitud:  'Parcial'
            };
            let res;
            if(currentMatchId){
                res = await supabaseClient.from('partidos').update(dataObj).eq('id', currentMatchId);
            } else {
                res = await supabaseClient.from('partidos').insert([dataObj]);
            }
            if(res.error){
                alert('Error: ' + res.error.message);
            } else {
                currentMatchId = matchId;
                document.getElementById('btn-create').textContent = 'Modificar Partido';
                document.querySelector('.schedule-section').classList.remove('schedule-section-disabled');
                document.getElementById('btn-schedule').disabled = false;
                alert(currentMatchId ? 'Partido modificado correctamente.' : 'Partido creado correctamente.');
            }
        });

        /*************************************************
         *  PROGRAMAR PARTIDOS REPETIDOS                *
         *************************************************/
        document.getElementById('btn-schedule').addEventListener('click', async function(){
            const weeks = +document.getElementById('repeatWeeks').value;
            const matchDateInput = document.getElementById('matchDate').value;
            if(!matchDateInput){ alert('Primero ingresa la fecha del partido.'); return; }

            const baseDate = getLocalDate(matchDateInput);

            const name      = document.getElementById('matchName').value.trim();
            const startTime = document.getElementById('startTime').value;
            const endTime   = document.getElementById('endTime').value;
            const cancha    = document.getElementById('canchaSelect').value;
            const pista     = document.getElementById('pistaSelect').value;
            const level     = document.getElementById('matchLevel').value;
            const type      = document.getElementById('teamType').value;
            const org       = document.getElementById('organizer').value;
            const count     = +document.querySelector('input[name="playerCount"]:checked').value;

            const list = document.getElementById('scheduledList');
            list.innerHTML = '';
            const ul = document.createElement('ul');
            const scheduledMatches = [];

            for(let i=1; i<=weeks; i++){
                // 1) use setDate to avoid ms shifts
                const d = new Date(baseDate);
                d.setDate(baseDate.getDate() + i*7);
                const iso = d.toISOString().split('T')[0];
                const formatted = d.toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
                const li = document.createElement('li');
                li.textContent = `Partido: ${name} - Fecha: ${formatted}`;
                ul.appendChild(li);

                scheduledMatches.push({
                    id:           generatePartyId(),
                    match_name:   name,
                    match_date:   iso,
                    start_time:   startTime,
                    end_time:     endTime,
                    organizer:    org,
                    player_count: count,
                    cancha_id:    cancha,
                    pista_id:     pista,
                    match_level:  level,
                    team_type:    type,
                    // 2) use 'Parcial' instead of 'Pendiente'
                    completitud:  'Parcial'
                });
            }
            list.appendChild(ul);

            const btnSave = document.getElementById('btn-save-scheduled');
            if(scheduledMatches.length){
                btnSave.style.display = 'block';
                btnSave.disabled = false;
                btnSave.onclick = async ()=>{
                    btnSave.disabled = true;
                    const { error } = await supabaseClient.from('partidos').insert(scheduledMatches);
                    if(error){
                        alert('Error al guardar los partidos programados:\n' + error.message);
                        btnSave.disabled = false;
                    } else {
                        alert('Partidos programados guardados exitosamente.');
                        btnSave.style.display = 'none';
                        list.innerHTML = '';
                    }
                };
            }
        });

        /*************************************************
         *  UNIRSE AL PARTIDO (placeholder)             *
         *************************************************/
        document.getElementById('btn-join').addEventListener('click', ()=>alert('Funcionalidad próxima a implementarse'));

        /*************************************************
         *  RECALCULAR HORA DE FIN                       *
         *************************************************/
        function recalcEndTime(){
            const s = $('#startTime').val();
            const dur = +document.getElementById('durationMinutes').value || 0;
            if(!s||dur<=0) return;
            const [hh,mm] = s.split(':').map(Number);
            let tot = hh*60 + mm + dur;
            const H = Math.floor(tot/60)%24, M = tot%60;
            $('#endTime').val(String(H).padStart(2,'0')+':'+String(M).padStart(2,'0'));
        }
        document.getElementById('durationMinutes').addEventListener('input',function(){
            let v=+this.value||0; if(v>180){v=180;this.value=v;}
            document.getElementById('durationDisplay').textContent=v+' minutos';
            recalcEndTime();
        });

        document.addEventListener('DOMContentLoaded', ()=>{
            document.querySelector('.schedule-section').classList.add('schedule-section-disabled');
            document.getElementById('btn-schedule').disabled = true;
        });
    </script>
</body>
</html>
