<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Catch Up Padel - Crear Partido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Time‑picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/dmuy/MDTimePicker/mdtimepicker.css">
  <!-- jQuery & mdtimepicker -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/dmuy/MDTimePicker/mdtimepicker.js"></script>

  <style>
    /* (…tus estilos exactamente iguales a los del anterior archivo…) */
  </style>
</head>
<body>
  <header>
    <div class="logo"><i class="fas fa-racket"></i>Catch Up Padel</div>
    <nav><a href="home.html"><i class="fas fa-home"></i> Volver a Home</a></nav>
  </header>

  <div class="container">
    <h1><i class="fas fa-play-circle"></i> Crear Partido de Padel</h1>
    <form id="match-form">
      <!-- DATOS DEL PARTIDO -->
      <fieldset>
        <legend><i class="far fa-calendar-alt"></i> Datos del Partido</legend>
        <div class="form-group">
          <label for="matchName"><i class="fas fa-signature"></i> Nombre del Partido</label>
          <input type="text" id="matchName" placeholder="Ej. Torneo de Verano" required>
        </div>
        <div class="form-group">
          <label for="matchDate"><i class="fas fa-calendar-day"></i> Fecha del Partido</label>
          <input type="date" id="matchDate" required>
        </div>
        <div class="form-group">
          <label for="startTime"><i class="far fa-clock"></i> Hora de Inicio</label>
          <input type="text" id="startTime" placeholder="Selecciona la hora" required>
        </div>
        <div class="form-group duration-group">
          <label for="durationMinutes"><i class="fas fa-hourglass-half"></i> Duración (minutos)</label>
          <input type="number" id="durationMinutes" placeholder="Ej. 90" min="0" max="180" step="1" list="durationOptions">
          <datalist id="durationOptions">
            <option value="30"><option value="60"><option value="90"><option value="120"><option value="150"><option value="180">
          </datalist>
          <div id="durationDisplay">90 minutos</div>
        </div>
        <div class="form-group">
          <label for="endTime"><i class="far fa-clock"></i> Hora de Fin</label>
          <input type="text" id="endTime" placeholder="Calculado automáticamente" disabled>
        </div>
      </fieldset>

      <!-- ORGANIZADOR -->
      <fieldset>
        <legend><i class="fas fa-user-tie"></i> Datos del Organizador</legend>
        <div class="form-group">
          <label for="organizer"><i class="fas fa-user"></i> Organizador</label>
          <input type="text" id="organizer" readonly>
        </div>
      </fieldset>

      <!-- DETALLES -->
      <fieldset>
        <legend><i class="fas fa-info-circle"></i> Detalles del Partido</legend>
        <div class="form-group">
          <label><i class="fas fa-users"></i> Cantidad de Jugadores</label>
          <div class="radio-group">
            <label><input type="radio" name="playerCount" value="2" required>2 jugadores</label>
            <label><input type="radio" name="playerCount" value="4" required>4 jugadores</label>
            <label><input type="radio" name="playerCount" value="6" required>6 jugadores</label>
          </div>
        </div>
        <div class="form-group">
          <label for="canchaSelect"><i class="fas fa-map-marker-alt"></i> Cancha</label>
          <select id="canchaSelect" required>
            <option value="">Seleccione una cancha</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pistaSelect"><i class="fas fa-map-pin"></i> Pista</label>
          <select id="pistaSelect" required>
            <option value="">Seleccione una pista</option>
          </select>
        </div>
        <div class="form-group">
          <label for="matchLevel"><i class="fas fa-signal"></i> Nivel del Partido</label>
          <select id="matchLevel" required>
            <option value="">Seleccione el nivel</option>
            <option value="Principiante">Principiante</option>
            <option value="Intermedios">Intermedios</option>
            <option value="Avanzados">Avanzados</option>
          </select>
        </div>
        <div class="form-group">
          <label for="teamType"><i class="fas fa-venus-mars"></i> Tipo de Parejas</label>
          <select id="teamType" required>
            <option value="">Seleccione el tipo</option>
            <option value="Femenino">Femenino</option>
            <option value="Masculino">Masculino</option>
            <option value="Mixto">Mixto</option>
          </select>
        </div>
        <div class="form-group">
          <label for="completitud"><i class="fas fa-check-double"></i> Completitud</label>
          <input type="text" id="completitud" value="Parcial (faltan 0)" readonly>
        </div>
      </fieldset>

      <button type="submit" id="btn-create" class="btn"><i class="fas fa-plus-circle"></i> Crear Partido</button>

      <!-- PROGRAMAR PARTIDOS -->
      <fieldset class="schedule-section schedule-section-disabled">
        <legend><i class="fas fa-calendar-week"></i> Programar Partidos</legend>
        <div class="form-group">
          <label for="repeatWeeks"><i class="fas fa-redo"></i> Repetir durante (semanas):</label>
          <select id="repeatWeeks">
            <option value="0">No repetir</option>
            <script>for(let i=1;i<=12;i++){document.write(`<option value="${i}">${i} semana${i>1?'s':''}</option>`);}</script>
          </select>
          <button type="button" id="btn-schedule" class="btn btn-schedule" disabled><i class="fas fa-calendar-plus"></i> Programar</button>
        </div>
        <div id="scheduledList"></div>
        <button type="button" id="btn-save-scheduled" class="btn btn-primary" style="display:none;"><i class="fas fa-save"></i> Grabar Programación</button>
      </fieldset>

      <hr>

      <!-- UNIRSE -->
      <div class="join-section">
        <h2><i class="fas fa-handshake"></i> Unirse al Partido</h2>
        <button type="button" id="btn-join" class="btn"><i class="fas fa-user-plus"></i> Unirse</button>
        <div class="join-progress">
          <progress id="joinProgress" value="0" max="1"></progress>
          <div class="join-info" id="joinInfo">0 unidos / 0 necesarios</div>
        </div>
      </div>
    </form>
  </div>

  <!-- Supabase y lógica JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // --- Utils ---
    function generatePartyId() {
      return (10000 + Math.floor(Math.random() * 90000)).toString();
    }
    function getLocalDate(iso) {
      const [y,m,d] = iso.split('-').map(Number);
      return new Date(y,m-1,d,12);
    }

    // --- TimePicker ---
    $(document).ready(() => {
      $('#startTime')
        .mdtimepicker({ is24hour:true, format:'hh:mm', theme:'blue', readOnly:true })
        .on('change', recalcEndTime);
    });

    // --- Supabase init ---
    const SUPABASE_URL = 'https://idlvxinjfbsujpvxncbr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGci...';  // tu anon key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentMatchId = null;

    // Carga inicial
    loadOrganizer();
    loadCanchas();
    loadMatch();

    async function loadOrganizer() {
      const { data:{ session } } = await supabase.auth.getSession();
      if (session) {
        const { data:profile } = await supabase
          .from('profiles').select('full_name').eq('id', session.user.id).single();
        const name = profile?.full_name || session.user.email;
        document.getElementById('organizer').value = name;
      }
    }

    async function loadCanchas() {
      const { data, error } = await supabase.from('establishments').select('id,name');
      if (!error) {
        data.forEach(c => {
          const opt = new Option(c.name, c.id);
          document.getElementById('canchaSelect').add(opt);
        });
      }
    }

    document.getElementById('canchaSelect').addEventListener('change', async function(){
      const sel = document.getElementById('pistaSelect');
      sel.innerHTML = '<option value="">Seleccione una pista</option>';
      if (!this.value) return;
      const { data } = await supabase
        .from('pistas').select('id,court_name')
        .eq('establishment_id', this.value);
      data.forEach(p => sel.add(new Option(p.court_name, p.id)));
    });

    async function loadMatch() {
      const { data:{ session } } = await supabase.auth.getSession();
      if (session) {
        const { data:match } = await supabase
          .from('partidos').select('*')
          .eq('organizer', session.user.email)
          .maybeSingle();
        if (match) {
          currentMatchId = match.id;
          // ... cargas los campos igual que antes ...
          document.querySelector('.schedule-section').classList.remove('schedule-section-disabled');
          document.getElementById('btn-schedule').disabled = false;
          document.getElementById('btn-create').textContent = 'Modificar Partido';
        }
      }
    }

    // Crear / Modificar
    document.getElementById('match-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const id = currentMatchId || generatePartyId();
      const obj = {
        id,
        match_name: document.getElementById('matchName').value.trim(),
        match_date: document.getElementById('matchDate').value,
        start_time: document.getElementById('startTime').value,
        end_time: document.getElementById('endTime').value,
        organizer: document.getElementById('organizer').value,
        player_count: +document.querySelector('input[name="playerCount"]:checked').value,
        cancha_id: document.getElementById('canchaSelect').value,
        pista_id: document.getElementById('pistaSelect').value,
        match_level: document.getElementById('matchLevel').value,
        team_type: document.getElementById('teamType').value,
        // Uso el campo de la forma: cumple exactamente con lo que acepta tu DB
        completitud: document.getElementById('completitud').value
      };
      const res = currentMatchId
        ? await supabase.from('partidos').update(obj).eq('id', id)
        : await supabase.from('partidos').insert([obj]);
      if (res.error) {
        alert('Error: ' + res.error.message);
      } else {
        currentMatchId = id;
        document.querySelector('.schedule-section').classList.remove('schedule-section-disabled');
        document.getElementById('btn-schedule').disabled = false;
        alert(currentMatchId ? 'Partido modificado' : 'Partido creado');
      }
    });

    // Programar repetidos
    document.getElementById('btn-schedule').addEventListener('click', ()=>{
      const weeks = +document.getElementById('repeatWeeks').value;
      const baseDate = getLocalDate(document.getElementById('matchDate').value);
      const name = document.getElementById('matchName').value.trim();
      const start = document.getElementById('startTime').value;
      const end   = document.getElementById('endTime').value;
      const cancha = document.getElementById('canchaSelect').value;
      const pista  = document.getElementById('pistaSelect').value;
      const level  = document.getElementById('matchLevel').value;
      const type   = document.getElementById('teamType').value;
      const org    = document.getElementById('organizer').value;
      const count  = +document.querySelector('input[name="playerCount"]:checked').value;
      const comp   = document.getElementById('completitud').value;

      const list = document.getElementById('scheduledList');
      list.innerHTML = '';
      const matches = [];

      for (let i = 1; i <= weeks; i++) {
        const d = new Date(baseDate.getTime() + i * 7*24*60*60*1000);
        const iso = d.toISOString().split('T')[0];
        const txt = d.toLocaleDateString('es-ES', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
        const li = document.createElement('li');
        li.textContent = `Partido: ${name} - Fecha: ${txt}`;
        list.appendChild(li);

        matches.push({
          id: generatePartyId(),
          match_name: name,
          match_date: iso,
          start_time: start,
          end_time: end,
          organizer: org,
          player_count: count,
          cancha_id: cancha,
          pista_id: pista,
          match_level: level,
          team_type: type
          // NO envio aquí completitud: lo toma la DB por defecto
        });
      }

      const btnSave = document.getElementById('btn-save-scheduled');
      if (matches.length) {
        btnSave.style.display = 'block';
        btnSave.disabled = false;
        btnSave.onclick = async ()=>{
          btnSave.disabled = true;
          const { error } = await supabase.from('partidos').insert(matches);
          if (error) {
            alert('Error al grabar:\n'+error.message);
            btnSave.disabled = false;
          } else {
            alert('Programación guardada');
            list.innerHTML = '';
            btnSave.style.display = 'none';
          }
        };
      }
    });

    // Placeholder Unirse
    document.getElementById('btn-join').addEventListener('click', ()=>{
      alert('Próximamente disponible');
    });

    // Recalcula fin
    function recalcEndTime(){
      const s = $('#startTime').val();
      const d = +document.getElementById('durationMinutes').value || 0;
      if (!s || d<=0) return;
      const [hh,mm] = s.split(':').map(Number);
      let tot = hh*60+mm + d;
      const H = Math.floor(tot/60)%24, M = tot%60;
      $('#endTime').val(`${String(H).padStart(2,'0')}:${String(M).padStart(2,'0')}`);
    }
    document.getElementById('durationMinutes').addEventListener('input', function(){
      let v = +this.value||0;
      if (v>180) { v=180; this.value=v; }
      document.getElementById('durationDisplay').textContent = v+' minutos';
      recalcEndTime();
    });

    // Desactivar schedule al inicio
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelector('.schedule-section').classList.add('schedule-section-disabled');
      document.getElementById('btn-schedule').disabled = true;
    });
  </script>
</body>
</html>
