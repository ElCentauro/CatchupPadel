<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Catch Up Padel - Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        /* RESET Y ESTILOS GLOBALES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8f8f8; color: #333; }

        /* MENÚ DE NAVEGACIÓN */
        nav { width: 100%; background-color: #fff; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 100; position: relative; }
        .menu-container { display: flex; justify-content: space-evenly; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .menu-item { padding: 0.75rem 1.5rem; border: 2px solid #ff9500; border-radius: 8px; color: #ff9500; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; transition: background-color 0.3s, color 0.3s; cursor: pointer; text-decoration: none; }
        .menu-item:hover { background-color: #ff9500; color: #fff; }
        .menu-item.logout { border-color: #e74c3c; color: #e74c3c; }
        .menu-item.logout:hover { background-color: #e74c3c; color: #fff; }

        /* SECCIÓN HERO */
        .hero { position: relative; padding: 3rem 1rem; text-align: center; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url("https://images.unsplash.com/photo-1593341646581-529f6c49c5d1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80"); background-size: cover; background-position: center; color: #fff; min-height: 60vh; }
        .hero h1 { font-size: 3rem; font-weight: 700; margin-bottom: 1rem; color: #fff; }
        .hero p { font-size: 1.2rem; margin-bottom: 2rem; max-width: 700px; margin: 0 auto; line-height: 1.6; }

        /* TARJETAS FLOTANTES HERO */
        .cards-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; margin-top: 2rem; }
        .floating-card { background-color: rgba(255, 165, 0, 0.85); backdrop-filter: blur(12px); border-radius: 12px; padding: 1.75rem; width: 260px; text-align: center; color: #fff; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25); transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; cursor: pointer; position: relative; overflow: hidden; }
        .floating-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; opacity: 0.4; transition: opacity 0.3s ease-in-out; }
        .floating-card.card-canchas::before { background-image: url('cancha.png'); background-position: center 40%; background-size: 50%; }
        .floating-card.card-programa::before { background-image: url('cita.png'); background-position: center 45%; background-size: 40%; }
        .floating-card.card-jugadores::before { background-image: url('conoce.png'); background-position: center 45%; background-size: 40%; }
        .floating-card.card-partidos::before { background-image: url('siluetas.png'); background-position: center 40%; background-size: 45%; }
        .floating-card:hover { transform: translateY(-7px) scale(1.05); box-shadow: 0 14px 28px rgba(0, 0, 0, 0.3); }
        .floating-card:hover::before { opacity: 0.6; }
        .floating-card i { font-size: 2rem; color: #fff; margin-bottom: 0.5rem; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); position: relative; }
        .floating-card h3 { font-size: 1.2rem; margin-bottom: 0.25rem; color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); position: relative; }
        .floating-card p { font-size: 0.9rem; color: #eee; text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.5); position: relative; }

        @keyframes flashGreen { 0% { color: #2ecc71; } 50% { color: #a2d9ce; } 100% { color: #2ecc71; } }
        .blinking-title { animation: flashGreen 1.5s infinite; }

        /* SECCIONES DE BÚSQUEDA */
        .search-partidos, .search-canchas, .search-players { display: none; max-width: 1200px; margin: 2rem auto; padding: 1.5rem 2rem; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; }
        .search-partidos h2, .search-canchas h2, .search-players h2 { font-size: 1.8rem; margin-bottom: 1rem; color: #2c3e50; text-align: center; }
        .filter-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.8rem; margin-bottom: 1.5rem; }
        .filter-container input, .filter-container select { padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; width: auto; flex-grow: 1; min-width: 150px; font-family: 'Poppins', sans-serif; background-color: #fff; appearance: none; /* Para mejor estilo en algunos navegadores */}
        /* Estilo específico para el select para que parezca input */
         .filter-container select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
             background-repeat: no-repeat;
             background-position: right 0.75rem center;
             background-size: 16px 12px;
             padding-right: 2.5rem; /* Espacio para la flecha */
         }
        .filter-container button { padding: 0.75rem 1.5rem; background-color: #ff9500; color: #fff; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background-color 0.3s ease; flex-shrink: 0; }
        .filter-container button:hover { background-color: #e07e00; }
        .close-btn, .close-btn-partidos, .close-btn-players { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.4rem; color: #aaa; cursor: pointer; transition: color 0.3s; }
        .close-btn:hover, .close-btn-partidos:hover, .close-btn-players:hover { color: #333; }

        /* GRID DE RESULTADOS */
        #partidosResults, .results-container, #playersResults { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; padding: 1rem 0; }
        #playersResults { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }

        /* TARJETAS */
        .partido-card { background: linear-gradient(to bottom, #fff, #f9f9f9); border: 1px solid #eee; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.07); padding: 1rem; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; }
        .partido-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .partido-card h3 { font-size: 1.15rem; color: #2c3e50; margin-bottom: 0.6rem; }
        .partido-card p { font-size: 0.9rem; color: #555; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 8px; }
        .partido-card p i.fa-fw { color: #ff9500; width: 15px; text-align: center; }
        .partido-card .participants-avatars { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; align-items: center; min-height: 30px; }
        .partido-card .participants-avatars img { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; object-fit: cover; }
        .partido-card .btn-view-partido { display: block; width: 100%; margin-top: auto; padding: 0.6rem 1rem; background-color: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; text-align: center; }
        .partido-card .btn-view-partido:hover { background-color: #2980b9; }

        .card { background: #fff; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.07); overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .card-header { background: #007bff; color: #fff; padding: 10px 15px; font-size: 1.1rem; font-weight: 600; }
        .card-content { padding: 15px; color: #333; }
        .card-content p { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .card-content .distance-info { font-size: 0.85rem; color: #555; margin-top: 0.5rem; }
        .map-container { border-top: 1px solid #eee; padding: 10px 0; display: flex; justify-content: center; align-items: center; }
        .map-link { display: inline-block; padding: 0.5rem 1rem; background-color: #3498db; color: #fff; text-decoration: none; border-radius: 6px; font-size: 0.85rem; transition: background-color 0.3s ease; }
        .map-link:hover { background-color: #2980b9; }
        .map-placeholder { color: #777; font-size: 0.9rem; text-align: center; padding: 1rem; }

        .player-card { background: #fff; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.07); padding: 1rem; transition: transform 0.3s ease, box-shadow 0.3s ease; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .player-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 6px 15px rgba(0,0,0,0.12); }
        .player-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 0.75rem; border: 3px solid #eee; }
        .player-card h3 { font-size: 1.1rem; color: #2c3e50; margin-bottom: 0.3rem; font-weight: 600; }
        .player-card p { font-size: 0.85rem; color: #555; margin-bottom: 0.3rem; }
        .player-card p i { color: #ff9500; margin-right: 5px; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; z-index: 1000; padding: 1rem; backdrop-filter: blur(3px); }
        .modal-content { background: #fff; border-radius: 12px; color: #333; max-width: 600px; width: 95%; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 1.5rem 2rem; max-height: 90vh; overflow-y: auto; animation: modalFadeZoom 0.4s ease-out; }
        @keyframes modalFadeZoom { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal .close-modal { position: absolute; top: 10px; right: 10px; background: #eee; border: none; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; text-align: center; font-size: 1rem; cursor: pointer; color: #555; transition: background-color 0.3s, color 0.3s; z-index: 10; }
        .modal .close-modal:hover { background-color: #e74c3c; color: #fff; }

        #matchModal .modal-content { max-width: 550px; }
        #matchModal .btn-refresh { position: absolute; top: 10px; right: 50px; background-color: #2ecc71; color: #fff; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: background-color 0.3s; z-index: 10; }
        #matchModal .btn-refresh:hover { background-color: #27ae60; }
        #matchModal .participants-list-container { background: #fafafa; border-radius: 8px; padding: 10px 15px; margin-bottom: 1rem; border: 1px solid #eee; max-height: 150px; overflow-y: auto;}
        #matchModal ul { list-style: none; margin: 0; padding: 0; }
        #matchModal li { margin-bottom: 8px; display: flex; align-items: center; font-size: 0.95rem; }
        #matchModal li img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; object-fit: cover; border: 2px solid #ddd; }
        #matchModal h2 { margin-bottom: 1rem; font-size: 1.6rem; color: #2980b9; text-align: center; font-weight: 600; }
        #matchModal p { margin-bottom: 0.7rem; font-size: 1rem; color: #555; display: flex; align-items: center; gap: 8px; }
        #matchModal p i.fa-fw { width: 18px; text-align: center; color: #ff9500; }
        #matchModal p strong { display: inline-flex; align-items: center; gap: 8px; }
        #matchModal h3 { margin-top: 1.2rem; font-size: 1.1rem; color: #2c3e50; margin-bottom: 0.6rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #matchModal .missing-players { font-weight: 600; color: #e74c3c; text-align: center; margin-top: 0.5rem; display: block; }
        #matchModal .cancelled { text-decoration: line-through; color: #999; }
        #matchModal .btn-join, #matchModal .btn-leave { margin: 0.5rem; background-color: #3498db; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; }
        #matchModal .btn-join:hover, #matchModal .btn-leave:hover { background-color: #2980b9; }
        #matchModal .btn-leave { background-color: #e74c3c; }
        #matchModal .btn-leave:hover { background-color: #c0392b; }
        #modal-action-buttons { text-align: center; margin-top: 1rem; display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem;}

        #playerModal .modal-content { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: start; }
        #playerModal .player-image-column img { width: 100%; max-width: 180px; height: auto; aspect-ratio: 1 / 1; border-radius: 50%; object-fit: cover; border: 4px solid #ff9500; box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin: 0 auto; display: block; }
        #playerModal .player-details-column h2 { font-size: 1.8rem; font-weight: 600; color: #2c3e50; margin-bottom: 1rem; border-bottom: 2px solid #ff9500; padding-bottom: 0.5rem; }
        #playerModal .player-details-column p { font-size: 1rem; color: #444; margin-bottom: 0.8rem; display: flex; align-items: center; gap: 10px; min-height: 24px; }
        #playerModal .player-details-column p i.fa-fw { width: 20px; text-align: center; color: #ff9500; font-size: 1.1rem; }
        #playerModal .player-details-column .whatsapp-link a { display: inline-flex; align-items: center; text-decoration: none; color: #25D366; font-weight: 600; padding: 5px 10px; border-radius: 5px; background-color: #e8f5e9; transition: background-color 0.3s, color 0.3s; }
        #playerModal .player-details-column .whatsapp-link a:hover { background-color: #128C7E; color: #fff; }
        #playerModal .player-details-column .whatsapp-link i { margin-right: 8px; }
        #playerModal .placeholder-section { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed #ddd; }
        #playerModal .placeholder-section h4 { font-size: 1rem; color: #777; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 10px; }
        #playerModal .placeholder-section h4 i.fa-fw { width: 20px; text-align: center; color: #aaa; font-size: 1.1rem; }
        #playerModal .placeholder-section p { font-size: 0.9rem; color: #888; font-style: italic; padding-left: 30px; }
        @media (max-width: 600px) {
             #playerModal .modal-content { grid-template-columns: 1fr; gap: 1rem; padding: 1rem 1.5rem; }
             #playerModal .player-image-column img { max-width: 120px; margin-bottom: 1rem; }
             #playerModal .player-details-column h2 { font-size: 1.5rem; text-align: center; }
             #playerModal .player-details-column p, #playerModal .placeholder-section h4 { font-size: 0.9rem; }
             #playerModal .placeholder-section p { font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <nav>
         <div class="menu-container">
            <a href="perfil.html" class="menu-item" id="profileLink">Mi Perfil</a>
            <a href="#" class="menu-item" id="partidosButton" onclick="showPartidosSearch()">Partidos</a>
            <a href="#" class="menu-item" id="jugadoresButton" onclick="showPlayersSection()">Conoce Jugadores</a>
            <a href="#" class="menu-item logout" id="logoutButton" onclick="logout()">Cerrar Sesión</a>
        </div>
    </nav>

    <section class="hero">
         <h1>Bienvenido a Catch Up Padel</h1>
        <p>Conecta con jugadores de pádel cerca de ti y disfruta del mejor deporte en comunidad.</p>
        <div class="cards-container">
            <div class="floating-card card-canchas" onclick="showCanchaSearch()"> <i class="fas fa-map-marker-alt"></i> <h3>Buscar Canchas</h3> <p>Descubre canchas cercanas</p> </div>
            <div class="floating-card card-programa" ondblclick="window.location.href='partidos.html'"> <i class="fas fa-calendar-plus"></i> <h3>Programa Partidos</h3> <p>Crea y únete a juegos</p> </div>
            <div class="floating-card card-jugadores" onclick="showPlayersSection()"> <i class="fas fa-handshake"></i> <h3>Conoce Jugadores</h3> <p>Haz clic para buscar</p> </div>
            <div class="floating-card card-partidos" onclick="showPartidosSearch()"> <i class="fas fa-search"></i> <h3>Buscar Partidos Abiertos</h3> <p>Partidos futuros con cupos disponibles</p> </div>
        </div>
    </section>

    <div class="search-partidos" id="searchPartidosSection">
        <button class="close-btn-partidos" onclick="closePartidosSearch()" title="Cerrar"><i class="fas fa-times"></i></button>
        <h2>Partidos Abiertos</h2>
        <div class="filter-container">
            <input type="text" id="filterCanchasPartido" placeholder="Cancha..." />
            <input type="text" id="filterLocality" placeholder="Localidad..." />
            <select id="filterDateRange" title="Filtrar por fecha">
                <option value="this_week" selected>Esta Semana</option>
                <option value="today">Hoy</option>
                <option value="next_week">Próxima Semana</option>
                <option value="all">Todos</option>
            </select>
            <button id="btn-filter-partidos"><i class="fas fa-filter"></i> Filtrar</button>
        </div>
        <div id="partidosResults"><div class="loader"></div></div>
    </div>

    <div class="search-canchas" id="searchCanchasSection">
         <button class="close-btn" onclick="closeCanchaSearch()" title="Cerrar"><i class="fas fa-times"></i></button>
        <h2>Buscar Canchas</h2>
        <div class="filter-container">
            <input type="text" id="filterCanchasName" placeholder="Nombre del club..." list="namesList" />
            <datalist id="namesList"></datalist>
            <input type="text" id="filterCanchasLocality" placeholder="Localidad..." list="localityList" />
            <datalist id="localityList"></datalist>
            <button id="btn-filter-canchas"><i class="fas fa-search"></i> Buscar Canchas</button>
        </div>
        <div id="canchasFeedback"></div>
        <div class="results-container" id="canchasResults"><div class="loader"></div></div>
    </div>

    <div class="search-players" id="searchPlayersSection">
         <button class="close-btn-players" onclick="closePlayersSection()" title="Cerrar"><i class="fas fa-times"></i></button>
        <h2>Conoce Jugadores</h2>
        <div class="filter-container">
            <input type="text" id="filterPlayersName" placeholder="Nombre..." list="namesListPlayers" />
            <datalist id="namesListPlayers"></datalist>
            <input type="text" id="filterPlayersGameLevel" placeholder="Nivel de juego..." list="gameLevelListPlayers" />
            <datalist id="gameLevelListPlayers"></datalist>
            <input type="text" id="filterPlayersLocality" placeholder="Localidad..." list="localityListPlayers" />
            <datalist id="localityListPlayers"></datalist>
            <button id="btn-filter-players"><i class="fas fa-search"></i> Buscar Jugadores</button>
        </div>
        <div id="playersFeedback"></div>
        <div id="playersResults"><div class="loader"></div></div>
    </div>

    <div id="matchModal" class="modal">
         <div class="modal-content">
            <button class="close-modal" onclick="closeModal()" title="Cerrar"><i class="fas fa-times"></i></button>
            <button class="btn-refresh" onclick="refreshModal()" title="Refrescar"><i class="fas fa-sync-alt"></i></button>
            <div id="modalContent"><div class="loader"></div></div>
        </div>
    </div>

    <div id="playerModal" class="modal">
         <div class="modal-content">
             <button class="close-modal" onclick="closePlayerModal()" title="Cerrar"><i class="fas fa-times"></i></button>
             <div id="playerModalContent"><div class="loader"></div></div>
        </div>
    </div>

    <footer style="text-align:center; padding:1rem 0; background:#e9ecef; margin-top:2rem; color: #6c757d; font-size: 0.9rem;">
        © 2025 Catch Up Padel. Todos los derechos reservados.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://idlvxinjfbsujpvxncbr.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkbHZ4aW5qZmJzdWpwdnhuY2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE1NTgxMTMsImV4cCI6MjA1NzEzNDExM30.kojYn4tEbQJvafypVnq2TjF5JYCpFC7cBaKKk3qTkig";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let loggedUser = null;
        let allEstablishments = [];
        let playersDataMap = new Map();

        // --- Helper Functions ---
        function calculateAge(birthDateString) { if(!birthDateString)return"N/D";try{const d=new Date(birthDateString);if(isNaN(d.getTime()))return"N/D";const t=new Date();let a=t.getFullYear()-d.getFullYear();const m=t.getMonth()-d.getMonth();if(m<0||(m===0&&t.getDate()<d.getDate())){a--;}return a>=0?a:"N/D";}catch(e){console.error("Edad Err:",e);return"N/D";}}
        function formatDateISO(date) { return date.toISOString().split('T')[0]; }

        // --- Date Range Logic ---
        function getWeekDates(filterType) {
            const today = new Date();
            const todayISO = formatDateISO(today);
            let startDateISO = todayISO;
            let endDateISO = '';

            const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon,...
            const diffToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
            const endOfWeek = new Date(today);
            endOfWeek.setDate(today.getDate() + diffToSunday);
            endDateISO = formatDateISO(endOfWeek);

            const startOfNextWeek = new Date(endOfWeek);
            startOfNextWeek.setDate(endOfWeek.getDate() + 1);
            const startOfNextWeekISO = formatDateISO(startOfNextWeek);

            const endOfNextWeek = new Date(startOfNextWeek);
            endOfNextWeek.setDate(startOfNextWeek.getDate() + 6);
            const endOfNextWeekISO = formatDateISO(endOfNextWeek);

            switch (filterType) {
                case 'today': return { start: todayISO, end: todayISO };
                case 'this_week': return { start: todayISO, end: endDateISO };
                case 'next_week': return { start: startOfNextWeekISO, end: endOfNextWeekISO };
                case 'all': default: return { start: todayISO, end: null }; // null end date for 'all'
            }
        }

        // --- Session & UI Management ---
        async function checkProfile() { const pl=document.getElementById("profileLink");const lb=document.getElementById("logoutButton");const mi=document.querySelectorAll('.menu-item:not(#profileLink):not(#logoutButton)');const{data:{session},error:se}=await supabaseClient.auth.getSession();if(se){console.error("Sess Err:",se);loggedUser=null;pl.style.display='none';lb.style.display='none';mi.forEach(i=>i.style.display='none');return;}if(session&&session.user){lb.style.display='block';loggedUser={id:session.user.id,email:session.user.email};const{data:pd,error:pe}=await supabaseClient.from("profiles").select("id").eq("id",loggedUser.id).maybeSingle();if(pe){console.error("Prof Err:",pe);pl.textContent="Error";pl.style.display='block';mi.forEach(i=>i.style.display='none');return;}if(pd){pl.textContent="Mi Perfil";pl.href="perfil.html";pl.style.display='block';mi.forEach(i=>i.style.display='block');document.getElementById("canchasButton").style.display="none";document.getElementById("pistasButton").style.display="none";}else{pl.textContent="Crear Perfil";pl.href="perfil.html";pl.style.display='block';mi.forEach(i=>i.style.display='none');}}else{loggedUser=null;pl.style.display='none';lb.style.display='none';mi.forEach(i=>i.style.display='none');}}
        async function logout() { const{error}=await supabaseClient.auth.signOut();if(error){console.error("Logout Err:",error);alert("Error.");}else{window.location.href="index.html";}}
        async function preloadEstablishments() { const{data,error}=await supabaseClient.from("establishments").select("name,locality");if(error){console.error("Est Err:",error.message);return;}allEstablishments=data||[];const ns=new Set(),ls=new Set();allEstablishments.forEach(i=>{if(i.name)ns.add(i.name);if(i.locality)ls.add(i.locality);});const nl=document.getElementById("namesList");nl.innerHTML="";ns.forEach(n=>nl.appendChild(new Option(n,n)));const ll=document.getElementById("localityList");ll.innerHTML="";ls.forEach(l=>ll.appendChild(new Option(l,l)));}
        async function preloadPlayersData() { const{data,error}=await supabaseClient.from("profiles").select("full_name,game_level,locality");if(error){console.error("PlayerList Err:",error.message);return;}const ns=new Set(),gs=new Set(),ls=new Set();(data||[]).forEach(p=>{if(p.full_name)ns.add(p.full_name);if(p.game_level)gs.add(p.game_level);if(p.locality)ls.add(p.locality);});const nlp=document.getElementById("namesListPlayers");nlp.innerHTML="";ns.forEach(n=>nlp.appendChild(new Option(n,n)));const glp=document.getElementById("gameLevelListPlayers");glp.innerHTML="";gs.forEach(l=>glp.appendChild(new Option(l,l)));const llp=document.getElementById("localityListPlayers");llp.innerHTML="";ls.forEach(l=>llp.appendChild(new Option(l,l)));}

        // --- Navigation & Modal Controls ---
        function hideAllSections() { document.getElementById("searchPartidosSection").style.display="none";document.getElementById("searchCanchasSection").style.display="none";document.getElementById("searchPlayersSection").style.display="none";}
        function showPartidosSearch() { hideAllSections(); document.getElementById("searchPartidosSection").style.display = "block"; document.getElementById("filterDateRange").value = "this_week"; loadOpenPartidos( // Carga inicial con filtro 'this_week' por defecto
            document.getElementById("filterCanchasPartido").value.trim(),
            document.getElementById("filterLocality").value.trim(),
            'this_week'
         ); }
        function closePartidosSearch() { document.getElementById("searchPartidosSection").style.display = "none"; }
        document.getElementById("btn-filter-partidos").addEventListener("click", () => {
            const canchaFilter = document.getElementById("filterCanchasPartido").value.trim();
            const localityFilter = document.getElementById("filterLocality").value.trim();
            const dateFilter = document.getElementById("filterDateRange").value; // Leer valor del select
            loadOpenPartidos(canchaFilter, localityFilter, dateFilter); // Pasar filtro
        });
        function showCanchaSearch() { hideAllSections(); document.getElementById("searchCanchasSection").style.display = "block"; loadCanchas(); }
        function closeCanchaSearch() { document.getElementById("searchCanchasSection").style.display = "none"; }
        document.getElementById("btn-filter-canchas").addEventListener("click", () => { loadCanchas(document.getElementById("filterCanchasName").value.trim(), document.getElementById("filterCanchasLocality").value.trim()); });
        function showPlayersSection() { hideAllSections(); document.getElementById("searchPlayersSection").style.display = "block"; loadPlayers(); }
        function closePlayersSection() { document.getElementById("searchPlayersSection").style.display = "none"; }
        document.getElementById("btn-filter-players").addEventListener("click", () => { loadPlayers(document.getElementById("filterPlayersName").value.trim(), document.getElementById("filterPlayersGameLevel").value.trim(), document.getElementById("filterPlayersLocality").value.trim()); });
        function closeModal() { document.getElementById("matchModal").style.display="none";document.getElementById("modalContent").innerHTML="";if(document.getElementById("modalContent").getAttribute("data-match-id"))document.getElementById("modalContent").removeAttribute("data-match-id");}
        function closePlayerModal() { document.getElementById("playerModal").style.display="none";document.getElementById("playerModalContent").innerHTML="";}

        // --- Match Data Loading & Display ---
        // ***** JS MODIFICADO AQUÍ *****
        async function loadOpenPartidos(canchaFilter = "", localityFilter = "", dateFilter = "this_week") {
            const partidosResults = document.getElementById("partidosResults");
            partidosResults.innerHTML = '<div class="loader"></div>';

            const { start: startDateISO, end: endDateISO } = getWeekDates(dateFilter); // Obtener rango

            let query = supabaseClient.from("partidos")
                .select(`*, establishments(name, locality), participants(user_id, cancelled, leave_reason)`)
                .neq("completitud", "Completo")
                .order('match_date', { ascending: true })
                .order('start_time', { ascending: true });

            // Aplicar filtros de fecha a la consulta
            if (dateFilter === 'today') {
                query = query.eq('match_date', startDateISO);
            } else {
                query = query.gte('match_date', startDateISO); // Siempre desde fecha inicio
                if (endDateISO) { // Si hay fecha fin (no es 'all'), aplicarla
                    query = query.lte('match_date', endDateISO);
                }
            }

            // Aplicar filtros de cancha/localidad (igual que antes)
             if (canchaFilter || localityFilter) {
                 let estQuery = supabaseClient.from('establishments').select('id');
                 if (canchaFilter) estQuery = estQuery.ilike('name', `%${canchaFilter}%`);
                 if (localityFilter) estQuery = estQuery.ilike('locality', `%${localityFilter}%`);
                 const { data: estData, error: estError } = await estQuery;
                 if (estError || !estData || estData.length === 0) { partidosResults.innerHTML = "<p>Filtro cancha/loc no encontrado.</p>"; if(estError) console.error("Est Filter Err:", estError.message); return; }
                 const estIds = estData.map(e => e.id); query = query.in('establishment_id', estIds);
             }

            const { data, error } = await query; // Ejecutar consulta final

            // --- Renderizado (igual que antes, ya incluía team_type) ---
            if (error) { console.error("Partidos Err:", error.message); partidosResults.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; return; }
            if (!data || data.length === 0) { partidosResults.innerHTML = "<p>No hay partidos para filtros.</p>"; return; }
            partidosResults.innerHTML = "";
            const allPIds = new Set(data.flatMap(p=>p.participants?p.participants.filter(pt=>!pt.cancelled).map(pt=>pt.user_id):[])); let profMap=new Map(); if(allPIds.size>0){const{data:profData,error:profErr}=await supabaseClient.from("profiles").select("id,profile_pic").in("id",Array.from(allPIds)); if(!profErr&&profData){profData.forEach(p=>profMap.set(p.id,p.profile_pic||"https://via.placeholder.com/32"));}else if(profErr){console.error("Avatar Err:",profErr.message);}}
            data.forEach(partido=>{const actP=partido.participants?partido.participants.filter(p=>!p.cancelled):[];const jC=actP.length;const tP=partido.total_players||4;const miss=tP-jC;if(miss<=0&&partido.completitud!=="Completo")return;if(miss>0&&partido.completitud==="Completo")return;let avHTML="";const maxAv=5;let shC=0;actP.forEach(p=>{if(shC<maxAv){const pic=profMap.get(p.user_id)||"https://via.placeholder.com/32";avHTML+=`<img src="${pic}" alt="Avatar" title="Jugador"/>`;shC++;}});if(actP.length>maxAv){avHTML+=`<span style="font-size:0.8rem;color:#666;">+${actP.length-maxAv}</span>`;}
            const card=document.createElement("div");card.className="partido-card";const tClass=miss>0?"blinking-title":"";
            card.innerHTML=`<h3 class="${tClass}">${partido.match_name||'Partido'}</h3><p><i class="fas fa-calendar-alt fa-fw"></i> ${partido.match_date}</p><p><i class="fas fa-clock fa-fw"></i> ${partido.start_time} - ${partido.end_time}</p><p><i class="fas fa-map-marker-alt fa-fw"></i> ${partido.establishments?.name||'N/E'}</p><p><i class="fas fa-location-dot fa-fw"></i> ${partido.establishments?.locality||'N/E'}</p><p><i class="fas fa-layer-group fa-fw"></i> Nivel: ${partido.match_level||'N/E'}</p><p><i class="fas fa-user-friends fa-fw"></i> Tipo: ${partido.team_type||'N/E'}</p><p style="font-weight:bold;color:${miss>0?'#e74c3c':'#2ecc71'};"><i class="fas fa-users fa-fw"></i> ${miss>0?`Faltan ${miss}`:'Completo'}</p><div class="participants-avatars">${avHTML||'<span style="font-size:0.8rem;color:#888;">Sé el primero.</span>'}</div><button class="btn-view-partido" data-match-id="${partido.id}">Ver Detalles</button>`;card.querySelector(".btn-view-partido").addEventListener("click",()=>showModal(partido));partidosResults.appendChild(card);});
        }

        async function refreshMatch(matchId) { if(!matchId){return null;}const{data,error}=await supabaseClient.from("partidos").select(`*,establishments(name,locality),participants(user_id,cancelled,leave_reason)`).eq("id",matchId).single();if(error){console.error("Ref Err:",error.message);return null;}return data;}
        async function refreshModal() { const mc=document.getElementById("modalContent");const id=mc.getAttribute("data-match-id");if(!id){return;}mc.innerHTML='<div class="loader"></div>';const data=await refreshMatch(id);if(data)showModal(data);else{closeModal();alert("Error recarga.");}}
        async function joinMatch(matchId) { if(!loggedUser){alert("Login.");return;}const p=await refreshMatch(matchId);if(!p){alert("Err Check.");return;}const act=p.participants?p.participants.filter(p=>!p.cancelled):[];const tot=p.total_players||4;if(act.length>=tot){alert("Completo.");return;}const{data:ex,error:ce}=await supabaseClient.from("participants").select('*').eq('match_id',matchId).eq('user_id',loggedUser.id).maybeSingle();if(ce){alert("Err: "+ce.message);return;}if(ex){if(!ex.cancelled){return;}else{const{error:ue}=await supabaseClient.from("participants").update({cancelled:false,leave_reason:null}).match({match_id:matchId,user_id:loggedUser.id});if(ue)alert("Err: "+ue.message);else await checkAndUpdateMatchCompletitud(matchId);}}else{const{error:ie}=await supabaseClient.from("participants").insert([{match_id:matchId,user_id:loggedUser.id}]);if(ie)alert("Err: "+ie.message);else await checkAndUpdateMatchCompletitud(matchId);}const final=await refreshMatch(matchId);if(final)showModal(final);else closeModal();}
        async function rejoinMatch(matchId) { if(!loggedUser){alert("Login.");return;}const p=await refreshMatch(matchId);if(!p){alert("Err Check.");return;}const act=p.participants?p.participants.filter(p=>!p.cancelled):[];const tot=p.total_players||4;if(act.length>=tot){alert("Completo.");return;}const{error}=await supabaseClient.from("participants").update({cancelled:false,leave_reason:null}).match({match_id:matchId,user_id:loggedUser.id});if(error)alert("Err: "+error.message);else await checkAndUpdateMatchCompletitud(matchId);const final=await refreshMatch(matchId);if(final)showModal(final);else closeModal();}
        async function leaveMatch(matchId, explanation) { if(!loggedUser){alert("Login.");return;}const{error}=await supabaseClient.from("participants").update({cancelled:true,leave_reason:explanation||null}).match({match_id:matchId,user_id:loggedUser.id,cancelled:false});if(error)alert("Err: "+error.message);else await checkAndUpdateMatchCompletitud(matchId);const final=await refreshMatch(matchId);if(final)showModal(final);else closeModal();}
        async function checkAndUpdateMatchCompletitud(matchId) { const p=await refreshMatch(matchId);if(!p)return;const act=p.participants?p.participants.filter(p=>!p.cancelled):[];const tot=p.total_players||4;const comp=act.length>=tot;const stat=comp?"Completo":"Incompleto";if(p.completitud!==stat){const{error}=await supabaseClient.from("partidos").update({completitud:stat}).eq("id",matchId);if(error)console.error(`Err Upd Stat ${stat}:`,error.message);}}
        async function showModal(partido) {
            // Renderizado del modal ya incluye team_type
            const m=document.getElementById("matchModal");const mc=document.getElementById("modalContent");if(!partido||!partido.id){return;}mc.setAttribute("data-match-id",partido.id);mc.innerHTML='<div class="loader"></div>';m.style.display="flex";const up=await refreshMatch(partido.id);if(!up){mc.innerHTML='<p style="color:red;">Error.</p>';setTimeout(closeModal,2500);return;}const actP=up.participants?up.participants.filter(p=>!p.cancelled):[];const jC=actP.length;const tP=up.total_players||4;const miss=tP-jC;let uIds=up.participants?up.participants.map(p=>p.user_id):[];let pListHTML=`<div class="participants-list-container"><ul>`;if(uIds.length>0){const{data:uProfs,error:pErr}=await supabaseClient.from("profiles").select("id,full_name,profile_pic").in("id",uIds);if(pErr){pListHTML+="<li>Error lista.</li>";}else if(uProfs&&uProfs.length>0){const pMap=new Map(uProfs.map(u=>[u.id,u]));up.participants.forEach(p=>{const u=pMap.get(p.user_id);if(u){const s=p.cancelled?"cancelled":"";const r=p.cancelled&&p.leave_reason?` - (${p.leave_reason.substring(0,30)}${p.leave_reason.length>30?'...':''})`:"";const pic=u.profile_pic||"https://via.placeholder.com/40";pListHTML+=`<li><img src="${pic}" alt="Foto"/> <span class="${s}">${u.full_name}${r}</span></li>`;}else{pListHTML+=`<li>Jugador ID ${p.user_id} (NF) ${p.cancelled?'(Baja)':''}</li>`;}}); }else{pListHTML+="<li>Sin jugadores.</li>";}}else{pListHTML+="<li>Sin jugadores.</li>";} pListHTML+="</ul></div>";
            mc.innerHTML=`<h2>${up.match_name||'Detalles'}</h2><p><i class="fas fa-calendar-alt fa-fw"></i> ${up.match_date}</p><p><i class="fas fa-clock fa-fw"></i> ${up.start_time} - ${up.end_time}</p><p><i class="fas fa-map-marker-alt fa-fw"></i> ${up.establishments?.name||'N/E'}</p><p><i class="fas fa-location-dot fa-fw"></i> ${up.establishments?.locality||'N/E'}</p><p><strong><i class="fas fa-layer-group fa-fw"></i> Nivel:</strong> ${up.match_level||'N/E'}</p><p><strong><i class="fas fa-user-friends fa-fw"></i> Tipo Pareja:</strong> ${up.team_type||'N/E'}</p><h3>Jugadores (${jC}/${tP}):</h3>${pListHTML}<p class="missing-players">${miss>0?`Faltan ${miss}`:'Completo'}</p><div id="modal-action-buttons"></div>`;
            const btns=mc.querySelector("#modal-action-buttons");if(!loggedUser){btns.innerHTML="<p><em>Login.</em></p>";}else{const ur=up.participants?up.participants.find(p=>p.user_id===loggedUser.id):null;if(!ur){if(miss>0){const b=document.createElement("button");b.className="btn-join";b.textContent="Unirme";b.onclick=()=>joinMatch(up.id);btns.appendChild(b);}else{btns.innerHTML="<p>Completo.</p>";}}else if(!ur.cancelled){btns.innerHTML="<p style='color:green;font-weight:bold;'>¡Apuntado!</p>";const b=document.createElement("button");b.className="btn-leave";b.textContent="Baja";b.onclick=()=>{let r=prompt("Motivo:");if(r!==null)leaveMatch(up.id,r.slice(0,50));};btns.appendChild(b);}else{btns.innerHTML=`<p>Baja ${ur.leave_reason?`(${ur.leave_reason})`:''}.</p>`;if(miss>0){const b=document.createElement("button");b.className="btn-join";b.textContent="Re-Unirme";b.onclick=()=>rejoinMatch(up.id);btns.appendChild(b);}}}
        }

        // --- Canchas ---
         async function loadCanchas(nameFilter = "", localityFilter = "") { const cr=document.getElementById("canchasResults");const cf=document.getElementById("canchasFeedback");cr.innerHTML="";cf.innerHTML="";showCanchasLoader();let q=supabaseClient.from("establishments").select("*");if(nameFilter)q=q.ilike("name",`%${nameFilter}%`);if(localityFilter)q=q.ilike("locality",`%${localityFilter}%`);q=q.order('name');const{data,error}=await q;clearCanchasLoader();if(error){cf.innerHTML=`<p style="color:red;">Error: ${error.message}</p>`;return;}if(!data||data.length===0){cr.innerHTML='<p>No encontradas.</p>';return;}const cd=data;cd.forEach(c=>{const card=document.createElement("div");card.className="card";c.element=card;const link=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address+', '+c.locality)}`;card.innerHTML=`<div class="card-header">${c.name}</div><div class="card-content"><p><strong>Localidad:</strong> ${c.locality||'N/D'}</p><p><strong>Dirección:</strong> ${c.address||'N/D'}</p><p><strong>Canchas:</strong> ${c.court_count||'N/D'}</p><p class="distance-info" id="distance-${c.id}">...</p></div><div class="map-container" id="map-container-${c.id}"><a href="${link}" class="map-link" target="_blank">Ver Mapa</a></div>`;cr.appendChild(card);});getUserLocationForDistance(cd);}
         function showCanchasLoader(){document.getElementById("canchasFeedback").innerHTML='<div class="loader"></div>';}
         function clearCanchasLoader(){document.getElementById("canchasFeedback").innerHTML="";}
         function getUserLocationForDistance(canchasData) { if (!canchasData||!navigator.geolocation){(canchasData||[]).forEach(c=>{const d=document.getElementById(`distance-${c.id}`);if(d)d.textContent='Dist N/D';const m=document.getElementById(`map-container-${c.id}`);if(m&&!m.querySelector('.map-link')){const l=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address+', '+c.locality)}`;m.innerHTML=`<a href="${l}" class="map-link">Ver Mapa</a>`;}});if(!navigator.geolocation)console.warn("No Geo.");return;} navigator.geolocation.getCurrentPosition(pos=>{const lat=pos.coords.latitude;const lon=pos.coords.longitude;canchasData.forEach(c=>{if(c.latitude!=null&&c.longitude!=null){const km=calculateDistance(lat,lon,c.latitude,c.longitude);const d=document.getElementById(`distance-${c.id}`);if(d)d.innerHTML=`<strong>Dist:</strong> ${km.toFixed(1)} km`;}else{const d=document.getElementById(`distance-${c.id}`);if(d)d.textContent='Dist N/C';} const m=document.getElementById(`map-container-${c.id}`);if(m){const dest=(c.latitude!=null&&c.longitude!=null)?`${c.latitude},${c.longitude}`:encodeURIComponent(c.address+', '+c.locality);const l=`https://www.google.com/maps/dir/?api=1&origin=${lat},${lon}&destination=${dest}&travelmode=driving`;m.innerHTML=`<a href="${l}" class="map-link">Cómo llegar</a>`;}});},error=>{console.warn("Geo Err:",error.message);canchasData.forEach(c=>{const d=document.getElementById(`distance-${c.id}`);if(d)d.textContent='Dist: Ubic N/D';const m=document.getElementById(`map-container-${c.id}`);if(m&&!m.querySelector('.map-link')){const l=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address+', '+c.locality)}`;m.innerHTML=`<a href="${l}" class="map-link">Ver Mapa</a>`;}});},{enableHighAccuracy:false,timeout:10000,maximumAge:60000});}
         function calculateDistance(lat1,lon1,lat2,lon2){if(lat1==null||lon1==null||lat2==null||lon2==null)return Infinity;const R=6371;const dLat=deg2rad(lat2-lat1);const dLon=deg2rad(lon2-lon1);const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}
         function deg2rad(deg){return deg*(Math.PI/180);}

        // --- Jugadores ---
        async function loadPlayers(nameFilter = "", gameLevelFilter = "", localityFilter = "") { const pr=document.getElementById("playersResults");const pf=document.getElementById("playersFeedback");pr.innerHTML='<div class="loader"></div>';pf.innerHTML="";playersDataMap.clear();let q=supabaseClient.from("profiles").select("id,full_name,profile_pic,birth_date,gender,game_level,locality,phone");if(nameFilter)q=q.ilike("full_name",`%${nameFilter}%`);if(gameLevelFilter)q=q.ilike("game_level",`%${gameLevelFilter}%`);if(localityFilter)q=q.ilike("locality",`%${localityFilter}%`);if(loggedUser)q=q.neq('id',loggedUser.id);q=q.order('full_name');const{data,error}=await q;pr.innerHTML="";if(error){pf.innerHTML=`<p style="color:red;">Error: ${error.message}</p>`;console.error("Player Err:",error);return;}if(!data||data.length===0){pr.innerHTML='<p>No encontrados.</p>';return;}data.forEach(p=>{playersDataMap.set(p.id,p);const c=document.createElement("div");c.className="player-card";c.setAttribute("onclick",`showPlayerModal('${p.id}')`);c.innerHTML=`<img src="${p.profile_pic||"https://via.placeholder.com/80"}" alt="Foto"/><h3>${p.full_name||'Jugador'}</h3><p><i class="fas fa-layer-group"></i> ${p.game_level||'N/D'}</p><p><i class="fas fa-location-dot"></i> ${p.locality||'N/D'}</p>`;pr.appendChild(c);});}
        function showPlayerModal(playerId) { const p=playersDataMap.get(playerId);if(!p){alert("Err detalles.");return;}const m=document.getElementById("playerModal");const mc=document.getElementById("playerModalContent");mc.innerHTML="";const age=calculateAge(p.birth_date);const pic=p.profile_pic||"https://via.placeholder.com/180";let wHtml='';if(p.phone){const num=p.phone.replace(/\D/g,'');let wNum=num;if(num.length>8&&num.length<12&&!num.startsWith('54')){wNum='549'+num;}else if(num.length===8&&p.locality&&p.locality.toLowerCase().includes('capital federal')){wNum='5411'+num;} wHtml=`<p class="whatsapp-link"><i class="fab fa-whatsapp fa-fw"></i> <a href="https://wa.me/${wNum}" target="_blank">Enviar Mensaje</a></p>`;}else{wHtml='<p><i class="fab fa-whatsapp fa-fw"></i> N/P</p>';} mc.innerHTML=`<button class="close-modal" onclick="closePlayerModal()"><i class="fas fa-times"></i></button><div class="player-image-column"><img src="${pic}" alt="Foto"/></div><div class="player-details-column"><h2>${p.full_name||'Jugador'}</h2><p><i class="fas fa-cake-candles fa-fw"></i> ${age} a</p><p><i class="fas fa-venus-mars fa-fw"></i> ${p.gender||"N/D"}</p><p><i class="fas fa-layer-group fa-fw"></i> Nvl: ${p.game_level||"N/D"}</p><p><i class="fas fa-location-dot fa-fw"></i> ${p.locality||"N/D"}</p><p><i class="fas fa-phone fa-fw"></i> ${p.phone||"N/P"}</p>${wHtml}<div class="placeholder-section"><h4><i class="fas fa-user fa-fw"></i> Sobre mí</h4><p>${p.bio||"Sin desc."}</p></div><div class="placeholder-section"><h4><i class="fas fa-calendar-check fa-fw"></i> Disponib.</h4><p>${p.availability||"N/E"}</p></div><div class="placeholder-section"><h4><i class="fas fa-arrows-left-right fa-fw"></i> Posición</h4><p>${p.preferred_position||"N/E"}</p></div></div>`; m.style.display="flex";}

        // --- Inicialización ---
        document.addEventListener("DOMContentLoaded", async () => { await checkProfile();await preloadEstablishments();await preloadPlayersData();if(loggedUser&&document.getElementById("profileLink").textContent==="Mi Perfil"){showPartidosSearch();}else{hideAllSections();}});

    </script>
</body>
</html>