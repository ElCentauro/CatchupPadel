<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Catch Up Padel - Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        /* RESET Y ESTILOS GLOBALES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8f8f8; color: #333; }

        /* MENÚ DE NAVEGACIÓN */
        nav {
            width: 100%; background-color: #fff; padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 100; position: relative;
        }
        .menu-container {
            display: flex; justify-content: space-evenly; align-items: center; flex-wrap: wrap; gap: 1rem;
        }
        .menu-item {
            padding: 0.75rem 1.5rem; border: 2px solid #ff9500; border-radius: 8px; color: #ff9500;
            text-transform: uppercase; font-weight: 600; letter-spacing: 1px;
            transition: background-color 0.3s, color 0.3s; cursor: pointer; text-decoration: none;
        }
        .menu-item:hover { background-color: #ff9500; color: #fff; }
        .menu-item.logout { border-color: #e74c3c; color: #e74c3c; }
        .menu-item.logout:hover { background-color: #e74c3c; color: #fff; }

        /* SECCIÓN HERO */
        .hero {
            position: relative; padding: 3rem 1rem; text-align: center;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)),
            url("https://images.unsplash.com/photo-1593341646581-529f6c49c5d1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80");
            background-size: cover; background-position: center; color: #fff; min-height: 60vh;
        }
        .hero h1 { font-size: 3rem; font-weight: 700; margin-bottom: 1rem; color: #fff; }
        .hero p { font-size: 1.2rem; margin-bottom: 2rem; max-width: 700px; margin: 0 auto; line-height: 1.6; }

        /* TARJETAS FLOTANTES HERO */
        .cards-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; margin-top: 2rem; }
        .floating-card {
            background-color: rgba(255, 165, 0, 0.85); backdrop-filter: blur(12px); border-radius: 12px;
            padding: 1.75rem; width: 260px; text-align: center; color: #fff;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; cursor: pointer;
            position: relative; overflow: hidden;
        }
        .floating-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; opacity: 0.4; transition: opacity 0.3s ease-in-out; }
        .floating-card.card-canchas::before { background-image: url('cancha.png'); background-position: center 40%; background-size: 50%; }
        .floating-card.card-programa::before { background-image: url('cita.png'); background-position: center 45%; background-size: 40%; }
        .floating-card.card-jugadores::before { background-image: url('conoce.png'); background-position: center 45%; background-size: 40%; }
        .floating-card.card-partidos::before { background-image: url('siluetas.png'); background-position: center 40%; background-size: 45%; }
        .floating-card:hover { transform: translateY(-7px) scale(1.05); box-shadow: 0 14px 28px rgba(0, 0, 0, 0.3); }
        .floating-card:hover::before { opacity: 0.6; }
        .floating-card i { font-size: 2rem; color: #fff; margin-bottom: 0.5rem; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); position: relative; }
        .floating-card h3 { font-size: 1.2rem; margin-bottom: 0.25rem; color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); position: relative; }
        .floating-card p { font-size: 0.9rem; color: #eee; text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.5); position: relative; }

        /* Animación título partidos abiertos */
        @keyframes flashGreen { 0% { color: #2ecc71; } 50% { color: #a2d9ce; } 100% { color: #2ecc71; } }
        .blinking-title { animation: flashGreen 1.5s infinite; }

        /* SECCIONES DE BÚSQUEDA */
        .search-partidos, .search-canchas, .search-players {
            display: none; max-width: 1200px; margin: 2rem auto; padding: 1.5rem 2rem;
            background-color: #fff; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative;
        }
        .search-partidos h2, .search-canchas h2, .search-players h2 {
            font-size: 1.8rem; margin-bottom: 1rem; color: #2c3e50; text-align: center;
        }
        .filter-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .filter-container input { padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; width: 220px; }
        .filter-container button { padding: 0.75rem 1.5rem; background-color: #ff9500; color: #fff; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background-color 0.3s ease; }
        .filter-container button:hover { background-color: #e07e00; }
        .close-btn, .close-btn-partidos, .close-btn-players { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.4rem; color: #aaa; cursor: pointer; transition: color 0.3s; }
        .close-btn:hover, .close-btn-partidos:hover, .close-btn-players:hover { color: #333; }

        /* GRID DE RESULTADOS (Partidos, Canchas, Jugadores) */
        #partidosResults, .results-container, #playersResults {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Ajuste minmax para diferentes tarjetas */
            gap: 1.5rem; padding: 1rem 0; /* Quitar padding lateral para que el contenedor lo controle */
        }
         /* Específico para tarjetas de jugadores */
         #playersResults {
             grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); /* Más pequeñas */
         }

        /* TARJETAS DE PARTIDO */
        .partido-card { background: linear-gradient(to bottom, #fff, #f9f9f9); border: 1px solid #eee; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.07); padding: 1rem; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .partido-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .partido-card h3 { font-size: 1.15rem; color: #2c3e50; margin-bottom: 0.6rem; }
        .partido-card p { font-size: 0.9rem; color: #555; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 8px; }
        .partido-card p i { color: #ff9500; width: 15px; text-align: center; }
        .partido-card .participants-avatars { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; align-items: center; }
        .partido-card .participants-avatars img { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; object-fit: cover; }
        .partido-card .btn-view-partido { display: block; width: 100%; margin-top: 1rem; background-color: #3498db; color: #fff; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; }
        .partido-card .btn-view-partido:hover { background-color: #2980b9; }

        /* TARJETAS DE CANCHA */
        .card { background: #fff; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.07); overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .card-header { background: #007bff; color: #fff; padding: 10px 15px; font-size: 1.1rem; font-weight: 600; }
        .card-content { padding: 15px; color: #333; }
        .card-content p { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .card-content .distance-info { font-size: 0.85rem; color: #555; margin-top: 0.5rem; }
        .map-container { border-top: 1px solid #eee; padding: 10px 0; display: flex; justify-content: center; align-items: center; }
        .map-link { display: inline-block; padding: 0.5rem 1rem; background-color: #3498db; color: #fff; text-decoration: none; border-radius: 6px; font-size: 0.85rem; transition: background-color 0.3s ease; }
        .map-link:hover { background-color: #2980b9; }
        .map-placeholder { color: #777; font-size: 0.9rem; text-align: center; padding: 1rem; }


        /* TARJETAS DE JUGADOR (SIMPLIFICADAS) */
        .player-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.07);
            padding: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center; /* Centrar contenido */
            cursor: pointer; /* Indicar que es clickeable */
        }
        .player-card:hover {
            transform: translateY(-5px) scale(1.03); /* Efecto hover más pronunciado */
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }
        .player-card img {
            width: 80px; /* Más pequeño para la tarjeta resumen */
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 0.75rem;
            border: 3px solid #eee; /* Borde sutil */
        }
        .player-card h3 {
            font-size: 1.1rem; /* Ligeramente más pequeño */
            color: #2c3e50;
            margin-bottom: 0.3rem;
            font-weight: 600;
        }
        .player-card p {
            font-size: 0.85rem; /* Más pequeño */
            color: #555;
            margin-bottom: 0.3rem;
        }
         .player-card p i { /* Iconos en la tarjeta resumen */
             color: #ff9500;
             margin-right: 5px;
         }


        /* LOADER */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL BASE (Compartido por Match y Player) */
        .modal { /* Clase base para ambos modals */
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Más oscuro */
            justify-content: center; align-items: center;
            z-index: 1000; /* Asegurar que esté por encima de todo */
            padding: 1rem; /* Espacio por si el modal es muy grande */
            backdrop-filter: blur(3px); /* Efecto blur sutil */
        }
         .modal-content {
            background: #fff; /* Fondo blanco sólido */
            border-radius: 12px;
            color: #333;
            max-width: 600px; /* Un poco más ancho para detalles */
            width: 95%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 1.5rem 2rem; /* Más padding */
             max-height: 90vh; /* Altura máxima y scroll si es necesario */
             overflow-y: auto;
             animation: modalFadeZoom 0.4s ease-out; /* Nueva animación */
         }
        @keyframes modalFadeZoom {
             from { transform: scale(0.9); opacity: 0; }
             to { transform: scale(1); opacity: 1; }
        }
        .modal .close-modal {
            position: absolute; top: 10px; right: 10px;
            background: #eee; border: none; border-radius: 50%;
            width: 30px; height: 30px; line-height: 30px; text-align: center;
            font-size: 1rem; cursor: pointer; color: #555;
            transition: background-color 0.3s, color 0.3s;
        }
        .modal .close-modal:hover { background-color: #e74c3c; color: #fff; }

        /* MODAL PARTIDO (#matchModal) */
        #matchModal .modal-content { max-width: 550px; } /* Ligeramente más estrecho */
        #matchModal .btn-refresh { position: absolute; top: 10px; right: 50px; /* Al lado del cerrar */ background-color: #2ecc71; color: #fff; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: background-color 0.3s; }
        #matchModal .btn-refresh:hover { background-color: #27ae60; }
        #matchModal .participants-list-container { background: #fafafa; border-radius: 8px; padding: 10px 15px; margin-bottom: 1rem; border: 1px solid #eee; }
        #matchModal ul { list-style: none; margin: 0; padding: 0; }
        #matchModal li { margin-bottom: 8px; display: flex; align-items: center; font-size: 0.95rem; }
        #matchModal li img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; object-fit: cover; border: 2px solid #ddd; }
        #matchModal h2 { margin-bottom: 1rem; font-size: 1.6rem; color: #2980b9; text-align: center; font-weight: 600; }
        #matchModal p { margin-bottom: 0.7rem; font-size: 1rem; color: #555; }
        #matchModal h3 { margin-top: 1.2rem; font-size: 1.1rem; color: #2c3e50; margin-bottom: 0.6rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #matchModal .missing-players { font-weight: 600; color: #e74c3c; text-align: center; margin-top: 0.5rem; }
        #matchModal .cancelled { text-decoration: line-through; color: #999; }
        #matchModal .btn-join, #matchModal .btn-leave { margin-top: 1rem; background-color: #3498db; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; }
        #matchModal .btn-join:hover, #matchModal .btn-leave:hover { background-color: #2980b9; }
        #matchModal .btn-leave { background-color: #e74c3c; }
        #matchModal .btn-leave:hover { background-color: #c0392b; }


        /* MODAL JUGADOR (#playerModal) */
        #playerModal .modal-content {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Columna para imagen, columna para texto */
            gap: 2rem; /* Espacio entre columnas */
            align-items: start; /* Alinear al inicio */
        }
        #playerModal .player-image-column img {
            width: 100%; /* Imagen ocupa toda la columna */
            max-width: 180px; /* Tamaño máximo */
            height: auto;
            aspect-ratio: 1 / 1; /* Asegurar que sea cuadrada antes de redondear */
            border-radius: 50%; /* Imagen redonda */
            object-fit: cover;
            border: 4px solid #ff9500; /* Borde naranja */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            margin: 0 auto; /* Centrar si la columna es más ancha */
            display: block;
        }
        #playerModal .player-details-column h2 {
            font-size: 1.8rem; /* Nombre más grande */
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            border-bottom: 2px solid #ff9500;
            padding-bottom: 0.5rem;
        }
         #playerModal .player-details-column p {
             font-size: 1rem; /* Texto legible */
             color: #444;
             margin-bottom: 0.8rem; /* Buen espaciado */
             display: flex;
             align-items: center;
             gap: 10px; /* Espacio entre icono y texto */
             min-height: 24px; /* Altura mínima para alinear aunque no haya icono */
         }
         #playerModal .player-details-column p i.fa-fw { /* Iconos de ancho fijo */
             width: 20px; /* Ancho fijo */
             text-align: center;
             color: #ff9500; /* Iconos naranjas */
             font-size: 1.1rem; /* Tamaño de icono */
         }
         #playerModal .player-details-column .whatsapp-link a {
             display: inline-flex; /* Para alinear icono y texto */
             align-items: center;
             text-decoration: none;
             color: #25D366;
             font-weight: 600;
             padding: 5px 10px;
             border-radius: 5px;
             background-color: #e8f5e9; /* Fondo verde claro */
             transition: background-color 0.3s, color 0.3s;
         }
         #playerModal .player-details-column .whatsapp-link a:hover {
            background-color: #128C7E;
            color: #fff;
         }
         #playerModal .player-details-column .whatsapp-link i {
             margin-right: 8px; /* Separar icono WhatsApp del texto */
         }
         #playerModal .placeholder-section { /* Estilo para secciones futuras */
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px dashed #ddd;
         }
          #playerModal .placeholder-section h4 {
             font-size: 1rem;
             color: #777;
             margin-bottom: 0.5rem;
             display: flex;
             align-items: center;
             gap: 10px;
          }
           #playerModal .placeholder-section h4 i.fa-fw { /* Iconos en placeholders */
             width: 20px; text-align: center; color: #aaa; font-size: 1.1rem;
          }
          #playerModal .placeholder-section p {
             font-size: 0.9rem;
             color: #888;
             font-style: italic;
             padding-left: 30px; /* Indentar el texto del placeholder */
          }
        /* Responsive para el modal de jugador en pantallas pequeñas */
        @media (max-width: 600px) {
             #playerModal .modal-content {
                 grid-template-columns: 1fr; /* Una sola columna */
                 gap: 1rem;
                 padding: 1rem 1.5rem;
             }
             #playerModal .player-image-column img {
                 max-width: 120px; /* Imagen más pequeña */
                 margin-bottom: 1rem;
             }
             #playerModal .player-details-column h2 {
                 font-size: 1.5rem;
                 text-align: center;
             }
             #playerModal .player-details-column p,
             #playerModal .placeholder-section h4 {
                 font-size: 0.9rem; /* Texto un poco más pequeño en móvil */
             }
              #playerModal .placeholder-section p {
                  font-size: 0.85rem;
              }
        }

    </style>
</head>
<body>
    <nav>
        <div class="menu-container">
            <a href="perfil.html" class="menu-item" id="profileLink">Crear Perfil</a>
            <a href="#" class="menu-item" id="partidosButton" onclick="showPartidosSearch()">Partidos</a>
            <a href="#" class="menu-item" id="canchasButton" ondblclick="window.location.href='establecimiento.html'">Canchas</a>
            <a href="#" class="menu-item" id="pistasButton" ondblclick="window.location.href='pistas.html'">Pistas</a>
            <a href="#" class="menu-item" id="jugadoresButton" onclick="showPlayersSection()">Conoce Jugadores</a>
            <a href="#" class="menu-item logout" id="logoutButton" onclick="logout()">Cerrar Sesión</a>
        </div>
    </nav>

    <section class="hero">
        <h1>Bienvenido a Catch Up Padel</h1>
        <p>Conecta con jugadores de pádel cerca de ti y disfruta del mejor deporte en comunidad.</p>
        <div class="cards-container">
            <div class="floating-card card-canchas" onclick="showCanchaSearch()"> <i class="fas fa-map-marker-alt"></i> <h3>Buscar Canchas</h3> <p>Descubre canchas cercanas</p> </div>
            <div class="floating-card card-programa" ondblclick="window.location.href='partidos.html'"> <i class="fas fa-calendar-plus"></i> <h3>Programa Partidos</h3> <p>Crea y únete a juegos</p> </div>
            <div class="floating-card card-jugadores" onclick="showPlayersSection()"> <i class="fas fa-handshake"></i> <h3>Conoce Jugadores</h3> <p>Haz clic para buscar</p> </div>
            <div class="floating-card card-partidos" onclick="showPartidosSearch()"> <i class="fas fa-search"></i> <h3>Buscar Partidos Abiertos</h3> <p>Partidos futuros con cupos disponibles</p> </div>
        </div>
    </section>

    <div class="search-partidos" id="searchPartidosSection">
        <button class="close-btn-partidos" onclick="closePartidosSearch()" title="Cerrar"><i class="fas fa-times"></i></button>
        <h2>Partidos Abiertos</h2>
        <div class="filter-container">
            <input type="text" id="filterCanchasPartido" placeholder="Filtrar por cancha..." />
            <input type="text" id="filterLocality" placeholder="Filtrar por localidad..." />
            <button id="btn-filter-partidos"><i class="fas fa-filter"></i> Filtrar Partidos</button>
        </div>
        <div id="partidosResults"><div class="loader"></div></div>
    </div>

    <div class="search-canchas" id="searchCanchasSection">
        <button class="close-btn" onclick="closeCanchaSearch()" title="Cerrar"><i class="fas fa-times"></i></button>
        <h2>Buscar Canchas</h2>
        <div class="filter-container">
            <input type="text" id="filterCanchasName" placeholder="Nombre del club..." list="namesList" />
            <datalist id="namesList"></datalist>
            <input type="text" id="filterCanchasLocality" placeholder="Localidad..." list="localityList" />
            <datalist id="localityList"></datalist>
            <button id="btn-filter-canchas"><i class="fas fa-search"></i> Buscar Canchas</button>
        </div>
        <div id="canchasFeedback"></div>
        <div class="results-container" id="canchasResults"><div class="loader"></div></div>
    </div>

    <div class="search-players" id="searchPlayersSection">
        <button class="close-btn-players" onclick="closePlayersSection()" title="Cerrar"><i class="fas fa-times"></i></button>
        <h2>Conoce Jugadores</h2>
        <div class="filter-container">
            <input type="text" id="filterPlayersName" placeholder="Nombre..." list="namesListPlayers" />
            <datalist id="namesListPlayers"></datalist>
            <input type="text" id="filterPlayersGameLevel" placeholder="Nivel de juego..." list="gameLevelListPlayers" />
            <datalist id="gameLevelListPlayers"></datalist>
            <input type="text" id="filterPlayersLocality" placeholder="Localidad..." list="localityListPlayers" />
            <datalist id="localityListPlayers"></datalist>
            <button id="btn-filter-players"><i class="fas fa-search"></i> Buscar Jugadores</button>
        </div>
        <div id="playersFeedback"></div>
        <div id="playersResults"><div class="loader"></div></div> </div>

    <div id="matchModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()" title="Cerrar"><i class="fas fa-times"></i></button>
            <button class="btn-refresh" onclick="refreshModal()" title="Refrescar"><i class="fas fa-sync-alt"></i></button>
            <div id="modalContent"><div class="loader"></div></div>
        </div>
    </div>

    <div id="playerModal" class="modal">
        <div class="modal-content">
             <button class="close-modal" onclick="closePlayerModal()" title="Cerrar"><i class="fas fa-times"></i></button>
             <div id="playerModalContent"><div class="loader"></div></div>
        </div>
    </div>


    <footer style="text-align:center; padding:1rem 0; background:#e9ecef; margin-top:2rem; color: #6c757d; font-size: 0.9rem;">
        © 2025 Catch Up Padel. Todos los derechos reservados.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <script>
        const SUPABASE_URL = "https://idlvxinjfbsujpvxncbr.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkbHZ4aW5qZmJzdWpwdnhuY2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE1NTgxMTMsImV4cCI6MjA1NzEzNDExM30.kojYn4tEbQJvafypVnq2TjF5JYCpFC7cBaKKk3qTkig";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let loggedUser = null;
        let allEstablishments = [];
        let playersDataMap = new Map(); // Mapa para guardar datos de jugadores

        // Función para calcular la edad
        function calculateAge(birthDateString) {
            if (!birthDateString) return "N/D";
            try {
                const birthDate = new Date(birthDateString);
                if (isNaN(birthDate.getTime())) return "N/D";
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age >= 0 ? age : "N/D";
            } catch (e) {
                console.error("Error calculando edad:", e);
                return "N/D";
            }
        }

        // --- Gestión de Sesión y UI del Menú ---
        async function checkProfile() {
             const profileLink = document.getElementById("profileLink");
             const logoutButton = document.getElementById("logoutButton");
             const menuItems = document.querySelectorAll('.menu-item:not(#profileLink):not(#logoutButton)');

             const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

              if (sessionError) {
                  console.error("Error getting session:", sessionError);
                  // Manejar error de sesión si es necesario (ej: mostrar mensaje)
                  loggedUser = null;
                  profileLink.style.display = 'none';
                  logoutButton.style.display = 'none';
                  menuItems.forEach(item => item.style.display = 'none');
                  return;
              }

             if (session && session.user) {
                 logoutButton.style.display = 'block';
                 loggedUser = { id: session.user.id, email: session.user.email };

                 const { data: profileData, error: profileError } = await supabaseClient
                     .from("profiles")
                     .select("id") // Solo necesitamos saber si existe
                     .eq("id", loggedUser.id)
                     .maybeSingle();

                  if (profileError) {
                      console.error("Error checking profile:", profileError);
                      // Podrías ocultar todo o mostrar un estado de error
                      profileLink.textContent = "Error Perfil";
                      profileLink.style.display = 'block';
                      menuItems.forEach(item => item.style.display = 'none');
                      return;
                  }

                 if (profileData) { // Tiene perfil
                     profileLink.textContent = "Mi Perfil";
                     profileLink.href = "perfil.html";
                     profileLink.style.display = 'block';
                     menuItems.forEach(item => item.style.display = 'block');
                      // Ocultar botones según tipo de perfil si fuera necesario
                     document.getElementById("canchasButton").style.display = "none"; // Ejemplo
                     document.getElementById("pistasButton").style.display = "none"; // Ejemplo

                 } else { // No tiene perfil
                     profileLink.textContent = "Crear Perfil";
                     profileLink.href = "perfil.html";
                     profileLink.style.display = 'block';
                     menuItems.forEach(item => item.style.display = 'none');
                 }

             } else { // No hay sesión
                 loggedUser = null;
                 profileLink.style.display = 'none';
                 logoutButton.style.display = 'none';
                 menuItems.forEach(item => item.style.display = 'none');
             }
        }

        async function logout() {
             const { error } = await supabaseClient.auth.signOut();
             if (error) {
                 console.error("Error logging out:", error);
                 alert("Error al cerrar sesión. Intenta de nuevo.");
             } else {
                 window.location.href = "index.html"; // O recargar la página actual si prefieres
             }
        }

        // --- Precarga de Datos para Filtros ---
        async function preloadEstablishments() {
             const { data, error } = await supabaseClient.from("establishments").select("name, locality");
             if (error) { console.error("Error cargando establecimientos:", error.message); return; }
             allEstablishments = data || [];
             const namesSet = new Set(), localitiesSet = new Set();
             allEstablishments.forEach(item => {
                 if(item.name) namesSet.add(item.name);
                 if(item.locality) localitiesSet.add(item.locality);
             });
             const namesList = document.getElementById("namesList");
             namesList.innerHTML = ""; namesSet.forEach(name => namesList.appendChild(new Option(name, name)));
             const localityList = document.getElementById("localityList");
             localityList.innerHTML = ""; localitiesSet.forEach(loc => localityList.appendChild(new Option(loc, loc)));
        }

        async function preloadPlayersData() {
             const { data, error } = await supabaseClient.from("profiles").select("full_name, game_level, locality");
             if (error) { console.error("Error cargando datos de jugadores para filtros:", error.message); return; }
             const namesSet = new Set(), gameLevelsSet = new Set(), localitiesSet = new Set();
             (data || []).forEach(player => {
                 if(player.full_name) namesSet.add(player.full_name);
                 if(player.game_level) gameLevelsSet.add(player.game_level);
                 if(player.locality) localitiesSet.add(player.locality);
             });
             const namesListPlayers = document.getElementById("namesListPlayers");
             namesListPlayers.innerHTML = ""; namesSet.forEach(name => namesListPlayers.appendChild(new Option(name, name)));
             const gameLevelListPlayers = document.getElementById("gameLevelListPlayers");
             gameLevelListPlayers.innerHTML = ""; gameLevelsSet.forEach(level => gameLevelListPlayers.appendChild(new Option(level, level)));
             const localityListPlayers = document.getElementById("localityListPlayers");
             localityListPlayers.innerHTML = ""; localitiesSet.forEach(loc => localityListPlayers.appendChild(new Option(loc, loc)));
        }

        // --- Funciones para mostrar/ocultar secciones y modales ---
        function hideAllSections() {
            document.getElementById("searchPartidosSection").style.display = "none";
            document.getElementById("searchCanchasSection").style.display = "none";
            document.getElementById("searchPlayersSection").style.display = "none";
        }
        function showPartidosSearch() { hideAllSections(); document.getElementById("searchPartidosSection").style.display = "block"; loadOpenPartidos(); }
        function closePartidosSearch() { document.getElementById("searchPartidosSection").style.display = "none"; }
        document.getElementById("btn-filter-partidos").addEventListener("click", () => { loadOpenPartidos(document.getElementById("filterCanchasPartido").value.trim(), document.getElementById("filterLocality").value.trim()); });
        function showCanchaSearch() { hideAllSections(); document.getElementById("searchCanchasSection").style.display = "block"; loadCanchas(); }
        function closeCanchaSearch() { document.getElementById("searchCanchasSection").style.display = "none"; }
        document.getElementById("btn-filter-canchas").addEventListener("click", () => { loadCanchas(document.getElementById("filterCanchasName").value.trim(), document.getElementById("filterCanchasLocality").value.trim()); });
        function showPlayersSection() { hideAllSections(); document.getElementById("searchPlayersSection").style.display = "block"; loadPlayers(); }
        function closePlayersSection() { document.getElementById("searchPlayersSection").style.display = "none"; }
        document.getElementById("btn-filter-players").addEventListener("click", () => { loadPlayers(document.getElementById("filterPlayersName").value.trim(), document.getElementById("filterPlayersGameLevel").value.trim(), document.getElementById("filterPlayersLocality").value.trim()); });
        function closeModal() { document.getElementById("matchModal").style.display = "none"; document.getElementById("modalContent").innerHTML = ""; if(document.getElementById("modalContent").getAttribute("data-match-id")) document.getElementById("modalContent").removeAttribute("data-match-id"); }
        function closePlayerModal() { document.getElementById("playerModal").style.display = "none"; document.getElementById("playerModalContent").innerHTML = ""; }

        // --- Carga y gestión de Partidos (loadOpenPartidos, refreshMatch, refreshModal, showModal, joinMatch, rejoinMatch, leaveMatch, checkAndUpdateMatchCompletitud) ---
        // ... (Estas funciones se mantienen igual que en la versión anterior, ya eran funcionales) ...
         async function loadOpenPartidos(canchaFilter = "", localityFilter = "") {
             const partidosResults = document.getElementById("partidosResults");
             partidosResults.innerHTML = '<div class="loader"></div>'; // Mostrar loader
             const todayISO = new Date().toISOString().slice(0, 10);

             let query = supabaseClient.from("partidos")
                 .select(`
                     *,
                     establishments ( name, locality ),
                     participants ( user_id, cancelled, leave_reason )
                 `)
                 .gte("match_date", todayISO)
                 .neq("completitud", "Completo")
                 .order('match_date', { ascending: true })
                 .order('start_time', { ascending: true });

              if (canchaFilter || localityFilter) {
                 let establishmentQuery = supabaseClient.from('establishments').select('id');
                 if (canchaFilter) establishmentQuery = establishmentQuery.ilike('name', `%${canchaFilter}%`);
                 if (localityFilter) establishmentQuery = establishmentQuery.ilike('locality', `%${localityFilter}%`);
                 const { data: establishmentData, error: establishmentError } = await establishmentQuery;

                 if (establishmentError || !establishmentData || establishmentData.length === 0) {
                     partidosResults.innerHTML = "<p>No se encontraron canchas que coincidan con los filtros para buscar partidos.</p>";
                     if(establishmentError) console.error("Error buscando establecimientos:", establishmentError.message);
                     return;
                 }
                 const establishmentIds = establishmentData.map(e => e.id);
                  query = query.in('establishment_id', establishmentIds);
             }

             const { data, error } = await query;

             if (error) {
                 console.error("Error buscando partidos abiertos:", error.message);
                 partidosResults.innerHTML = `<p style="color:red;">Error al cargar partidos: ${error.message}</p>`;
                 return;
             }
             if (!data || data.length === 0) {
                 partidosResults.innerHTML = "<p>No se encontraron partidos abiertos con los criterios seleccionados.</p>";
                 return;
             }

             partidosResults.innerHTML = ""; // Limpiar loader

             const allParticipantUserIds = new Set(data.flatMap(p => p.participants ? p.participants.filter(pt => !pt.cancelled).map(pt => pt.user_id) : []));
             let userProfilesMap = new Map();
              if (allParticipantUserIds.size > 0) {
                  const { data: profilesData, error: profilesError } = await supabaseClient.from("profiles").select("id, profile_pic").in("id", Array.from(allParticipantUserIds));
                  if (!profilesError && profilesData) {
                     profilesData.forEach(profile => userProfilesMap.set(profile.id, profile.profile_pic || "https://via.placeholder.com/32"));
                  } else if(profilesError){
                     console.error("Error cargando perfiles para avatares:", profilesError.message);
                  }
              }

             data.forEach(partido => {
                 const activeParticipants = partido.participants ? partido.participants.filter(p => !p.cancelled) : [];
                 const joinedCount = activeParticipants.length;
                 const totalPlayers = partido.total_players || 4;
                 const missing = totalPlayers - joinedCount;

                  if (missing <= 0 && partido.completitud !== "Completo") return;
                  if (missing > 0 && partido.completitud === "Completo") return;

                 let avatarsHTML = "";
                 const maxToShow = 5;
                 let shownCount = 0;
                 activeParticipants.forEach(p => {
                     if (shownCount < maxToShow) {
                          const pic = userProfilesMap.get(p.user_id) || "https://via.placeholder.com/32";
                          avatarsHTML += `<img src="${pic}" alt="Avatar" title="Jugador apuntado" />`;
                          shownCount++;
                     }
                 });
                 if (activeParticipants.length > maxToShow) {
                     avatarsHTML += `<span style="font-size:0.8rem; color:#666; align-self: center; margin-left: 4px;">+${activeParticipants.length - maxToShow}</span>`;
                 }

                 const card = document.createElement("div");
                 card.className = "partido-card";
                 const titleClass = missing > 0 ? "blinking-title" : "";

                 card.innerHTML = `
                     <h3 class="${titleClass}">${partido.match_name || 'Partido'}</h3>
                     <p><i class="fas fa-calendar-alt fa-fw"></i> ${partido.match_date}</p>
                     <p><i class="fas fa-clock fa-fw"></i> ${partido.start_time} - ${partido.end_time}</p>
                     <p><i class="fas fa-map-marker-alt fa-fw"></i> ${partido.establishments?.name || 'N/E'}</p>
                     <p><i class="fas fa-location-dot fa-fw"></i> ${partido.establishments?.locality || 'N/E'}</p>
                     <p><i class="fas fa-layer-group fa-fw"></i> Nivel: ${partido.match_level || 'N/E'}</p>
                     <p style="font-weight: bold; color: ${missing > 0 ? '#e74c3c' : '#2ecc71'};"><i class="fas fa-users fa-fw"></i> ${missing > 0 ? `Faltan ${missing}` : 'Completo'}</p>
                     <div class="participants-avatars">${avatarsHTML || '<span style="font-size:0.8rem; color:#888;">Sé el primero en unirte.</span>'}</div>
                     <button class="btn-view-partido" data-match-id="${partido.id}">Ver Detalles</button>
                 `;
                 card.querySelector(".btn-view-partido").addEventListener("click", () => showModal(partido));
                 partidosResults.appendChild(card);
             });
         }
         async function refreshMatch(matchId) {
             if (!matchId) { console.error("refreshMatch: Se requiere matchId"); return null; }
             const { data, error } = await supabaseClient.from("partidos").select(`*, establishments ( name, locality ), participants ( user_id, cancelled, leave_reason )`).eq("id", matchId).single();
             if (error) { console.error("Error refrescando partido:", error.message); /*alert("Error actualizando la información del partido: " + error.message);*/ return null; } // No alertar aquí
             return data;
         }
         async function refreshModal() {
             const modalContent = document.getElementById("modalContent");
             const currentMatchId = modalContent.getAttribute("data-match-id");
             if (!currentMatchId) { /*alert("No se pudo identificar el partido para refrescar.");*/ return; } // No alertar
             modalContent.innerHTML = '<div class="loader" style="margin: 50px auto;"></div>';
             const refreshedPartido = await refreshMatch(currentMatchId);
             if (refreshedPartido) showModal(refreshedPartido);
             else { closeModal(); alert("No se pudo recargar la información del partido. Intenta abrirlo de nuevo."); }
         }
         async function joinMatch(matchId) {
             if (!loggedUser) { alert("Debes iniciar sesión para unirte."); return; }
             const partidoActual = await refreshMatch(matchId);
             if (!partidoActual) { alert("No se pudo verificar el estado del partido."); return; }
             const activeParticipants = partidoActual.participants ? partidoActual.participants.filter(p => !p.cancelled) : [];
             const totalPlayers = partidoActual.total_players || 4;
             if (activeParticipants.length >= totalPlayers) { alert("Lo sentimos, el partido ya está completo."); return; }

             const { data: existing, error: checkError } = await supabaseClient.from("participants").select('*').eq('match_id', matchId).eq('user_id', loggedUser.id).maybeSingle();
             if (checkError) { alert("Error al verificar participación: " + checkError.message); return; }
             if (existing) {
                  if (!existing.cancelled) { return; }
                  else { // Reactivar
                     const { error: updateError } = await supabaseClient.from("participants").update({ cancelled: false, leave_reason: null }).match({ match_id: matchId, user_id: loggedUser.id });
                     if (updateError) alert("Error al volver a unirse: " + updateError.message);
                     else await checkAndUpdateMatchCompletitud(matchId);
                  }
             } else { // Insertar
                 const { error: insertError } = await supabaseClient.from("participants").insert([{ match_id: matchId, user_id: loggedUser.id }]);
                 if (insertError) alert("Error al unirse: " + insertError.message);
                 else await checkAndUpdateMatchCompletitud(matchId);
             }
              const finalMatchState = await refreshMatch(matchId); if(finalMatchState) showModal(finalMatchState); else closeModal(); // Refrescar o cerrar si falla
         }
         async function rejoinMatch(matchId) {
             if (!loggedUser) { alert("Debes iniciar sesión para unirte."); return; }
              const partidoActual = await refreshMatch(matchId);
              if (!partidoActual) { alert("No se pudo verificar el estado del partido."); return; }
              const activeParticipants = partidoActual.participants ? partidoActual.participants.filter(p => !p.cancelled) : [];
              const totalPlayers = partidoActual.total_players || 4;
              if (activeParticipants.length >= totalPlayers) { alert("Lo sentimos, el partido ya está completo."); return; }
              const { error } = await supabaseClient.from("participants").update({ cancelled: false, leave_reason: null }).match({ match_id: matchId, user_id: loggedUser.id });
              if (error) alert("Error al volver a unirse: " + error.message);
              else await checkAndUpdateMatchCompletitud(matchId);
              const finalMatchState = await refreshMatch(matchId); if(finalMatchState) showModal(finalMatchState); else closeModal(); // Refrescar o cerrar si falla
         }
         async function leaveMatch(matchId, explanation) {
             if (!loggedUser) { alert("Debes iniciar sesión para darte de baja."); return; }
             const { error } = await supabaseClient.from("participants").update({ cancelled: true, leave_reason: explanation || null }).match({ match_id: matchId, user_id: loggedUser.id, cancelled: false });
             if (error) alert("Error al darse de baja: " + error.message);
             else await checkAndUpdateMatchCompletitud(matchId);
              const finalMatchState = await refreshMatch(matchId); if(finalMatchState) showModal(finalMatchState); else closeModal(); // Refrescar o cerrar si falla
         }
         async function checkAndUpdateMatchCompletitud(matchId) {
             const partido = await refreshMatch(matchId);
             if (!partido) return;
             const activeParticipants = partido.participants ? partido.participants.filter(p => !p.cancelled) : [];
             const totalPlayers = partido.total_players || 4;
             const isComplete = activeParticipants.length >= totalPlayers;
             const newStatus = isComplete ? "Completo" : "Incompleto";
             if (partido.completitud !== newStatus) {
                  const { error } = await supabaseClient.from("partidos").update({ completitud: newStatus }).eq("id", matchId);
                  if (error) console.error(`Error actualizando estado a ${newStatus} para partido ${matchId}:`, error.message);
             }
         }
        async function showModal(partido) {
             const modal = document.getElementById("matchModal");
             const modalContent = document.getElementById("modalContent");
             if (!partido || !partido.id) { console.error("showModal: Objeto partido inválido."); return; }
             modalContent.setAttribute("data-match-id", partido.id);
             modalContent.innerHTML = '<div class="loader"></div>';
             modal.style.display = "flex";

              const updatedPartido = await refreshMatch(partido.id);
              if (!updatedPartido) {
                  modalContent.innerHTML = '<p style="color:red; text-align:center;">Error al cargar detalles del partido.</p>';
                  setTimeout(closeModal, 3000);
                  return;
              }

             const activeParticipants = updatedPartido.participants ? updatedPartido.participants.filter(p => !p.cancelled) : [];
             const joinedCount = activeParticipants.length;
             const totalPlayers = updatedPartido.total_players || 4;
             const missing = totalPlayers - joinedCount;

             let userIds = updatedPartido.participants ? updatedPartido.participants.map(p => p.user_id) : [];
             let participantListHTML = `<div class="participants-list-container"><ul>`;
             if (userIds.length > 0) {
                  const { data: userProfiles, error: profileError } = await supabaseClient.from("profiles").select("id, full_name, profile_pic").in("id", userIds);
                  if (profileError) { participantListHTML += "<li>Error al cargar lista de jugadores.</li>"; }
                  else if (userProfiles && userProfiles.length > 0) {
                       const profilesMap = new Map(userProfiles.map(usr => [usr.id, usr]));
                       updatedPartido.participants.forEach(p => {
                           const usr = profilesMap.get(p.user_id);
                           if (usr) {
                               const styleName = p.cancelled ? "cancelled" : "";
                               const reasonText = p.cancelled && p.leave_reason ? ` - (${p.leave_reason.substring(0,30)}${p.leave_reason.length > 30 ? '...' : ''})` : "";
                               const pic = usr.profile_pic || "https://via.placeholder.com/40";
                               participantListHTML += `<li><img src="${pic}" alt="Foto" /> <span class="${styleName}">${usr.full_name}${reasonText}</span></li>`;
                           } else { participantListHTML += `<li>Jugador ID ${p.user_id} (Datos no encontrados) ${p.cancelled ? '(Baja)' : ''}</li>`; }
                       });
                  } else { participantListHTML += "<li>Aún no hay jugadores apuntados.</li>"; }
             } else { participantListHTML += "<li>Aún no hay jugadores apuntados.</li>"; }
             participantListHTML += "</ul></div>";

             modalContent.innerHTML = `
                  <h2>${updatedPartido.match_name || 'Detalles del Partido'}</h2>
                  <p><strong>Fecha:</strong> ${updatedPartido.match_date}</p>
                  <p><strong>Hora:</strong> ${updatedPartido.start_time} - ${updatedPartido.end_time}</p>
                  <p><strong>Cancha:</strong> ${updatedPartido.establishments?.name || 'N/E'}</p>
                  <p><strong>Localidad:</strong> ${updatedPartido.establishments?.locality || 'N/E'}</p>
                  <p><strong>Nivel:</strong> ${updatedPartido.match_level || 'N/E'}</p>
                  <h3>Jugadores (${joinedCount}/${totalPlayers}):</h3>
                  ${participantListHTML}
                  <p class="missing-players">${missing > 0 ? `Faltan ${missing} jugador(es)` : '¡Equipo completo!'}</p>
                  <div id="modal-action-buttons" style="text-align:center; margin-top: 1rem;"></div>
              `;

             const actionButtonsContainer = modalContent.querySelector("#modal-action-buttons");
             if (!loggedUser) { actionButtonsContainer.innerHTML = "<p><em>Inicia sesión para unirte o darte de baja.</em></p>"; }
             else {
                  const userRecord = updatedPartido.participants ? updatedPartido.participants.find(p => p.user_id === loggedUser.id) : null;
                  if (!userRecord) {
                       if (missing > 0) { const btn = document.createElement("button"); btn.className = "btn-join"; btn.textContent = "Unirme"; btn.onclick = () => joinMatch(updatedPartido.id); actionButtonsContainer.appendChild(btn); }
                       else { actionButtonsContainer.innerHTML = "<p>Partido completo.</p>"; }
                  } else if (!userRecord.cancelled) {
                       actionButtonsContainer.innerHTML = "<p style='color:green; font-weight:bold;'>¡Estás apuntado!</p>"; const btn = document.createElement("button"); btn.className = "btn-leave"; btn.textContent = "Darme de baja"; btn.onclick = () => { let r = prompt("Motivo (opcional, máx 50 car.):"); if (r !== null) leaveMatch(updatedPartido.id, r.slice(0, 50)); }; actionButtonsContainer.appendChild(btn);
                  } else {
                       actionButtonsContainer.innerHTML = `<p>Te diste de baja ${userRecord.leave_reason ? `(Motivo: ${userRecord.leave_reason})` : ''}.</p>`;
                       if (missing > 0) { const btn = document.createElement("button"); btn.className = "btn-join"; btn.textContent = "Volver a Unirme"; btn.onclick = () => rejoinMatch(updatedPartido.id); actionButtonsContainer.appendChild(btn); }
                  }
             }
         }

        // --- Carga y gestión de Canchas (loadCanchas, showCanchasLoader, clearCanchasLoader, getUserLocationForDistance, calculateDistance, deg2rad) ---
        // ... (Estas funciones se mantienen igual que en la versión anterior) ...
         async function loadCanchas(nameFilter = "", localityFilter = "") {
             const canchasResults = document.getElementById("canchasResults");
             const canchasFeedback = document.getElementById("canchasFeedback");
             canchasResults.innerHTML = ""; canchasFeedback.innerHTML = "";
             showCanchasLoader();
             let query = supabaseClient.from("establishments").select("*");
             if (nameFilter) query = query.ilike("name", `%${nameFilter}%`);
             if (localityFilter) query = query.ilike("locality", `%${localityFilter}%`);
             query = query.order('name');
             const { data, error } = await query;
             clearCanchasLoader();
             if (error) { canchasFeedback.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; return; }
             if (!data || data.length === 0) { canchasResults.innerHTML = '<p style="text-align:center; width:100%;">No se encontraron canchas.</p>'; return; }
             const canchasData = data;
             canchasData.forEach(c => {
                  const card = document.createElement("div"); card.className = "card"; c.element = card;
                  const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address + ', ' + c.locality)}`;
                  card.innerHTML = `<div class="card-header">${c.name}</div><div class="card-content"><p><strong>Localidad:</strong> ${c.locality||'N/D'}</p><p><strong>Dirección:</strong> ${c.address||'N/D'}</p><p><strong>Canchas:</strong> ${c.court_count||'N/D'}</p><p class="distance-info" id="distance-${c.id}">Calculando...</p></div><div class="map-container" id="map-container-${c.id}"><a href="${googleMapsLink}" class="map-link" target="_blank">Ver Mapa</a></div>`;
                  canchasResults.appendChild(card);
             });
             getUserLocationForDistance(canchasData);
         }
         function showCanchasLoader() { document.getElementById("canchasFeedback").innerHTML = '<div class="loader"></div>'; }
         function clearCanchasLoader() { document.getElementById("canchasFeedback").innerHTML = ""; }
         function getUserLocationForDistance(canchasData) {
             if (!canchasData || canchasData.length === 0 || !navigator.geolocation) {
                 (canchasData || []).forEach(cancha => { const distDiv = document.getElementById(`distance-${cancha.id}`); if(distDiv) distDiv.textContent = 'Distancia no disponible'; const mapCont = document.getElementById(`map-container-${cancha.id}`); if (mapCont && !mapCont.querySelector('.map-link')) { const link = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cancha.address + ', ' + cancha.locality)}`; mapCont.innerHTML = `<a href="${link}" class="map-link" target="_blank">Ver Mapa</a>`;}});
                 if(!navigator.geolocation) console.warn("Geolocalización no soportada."); return;
             }
             navigator.geolocation.getCurrentPosition( pos => {
                 const userLat = pos.coords.latitude; const userLng = pos.coords.longitude;
                 canchasData.forEach(cancha => {
                     if (cancha.latitude != null && cancha.longitude != null) { const distKm = calculateDistance(userLat, userLng, cancha.latitude, cancha.longitude); const distDiv = document.getElementById(`distance-${cancha.id}`); if(distDiv) distDiv.innerHTML = `<strong>Distancia:</strong> ${distKm.toFixed(1)} km`; }
                     else { const distDiv = document.getElementById(`distance-${cancha.id}`); if(distDiv) distDiv.textContent = 'Distancia no calculable'; }
                     const mapCont = document.getElementById(`map-container-${cancha.id}`); if (mapCont) { const dest = (cancha.latitude != null && cancha.longitude != null) ? `${cancha.latitude},${cancha.longitude}` : encodeURIComponent(cancha.address + ', ' + cancha.locality); const link = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${dest}&travelmode=driving`; mapCont.innerHTML = `<a href="${link}" class="map-link" target="_blank">Cómo llegar</a>`; }
                 });
             }, error => {
                 console.warn("Error obteniendo ubicación:", error.message);
                 canchasData.forEach(cancha => { const distDiv = document.getElementById(`distance-${cancha.id}`); if(distDiv) distDiv.textContent = 'Distancia: Ubic. no disp.'; const mapCont = document.getElementById(`map-container-${cancha.id}`); if (mapCont && !mapCont.querySelector('.map-link')) { const link = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cancha.address + ', ' + cancha.locality)}`; mapCont.innerHTML = `<a href="${link}" class="map-link" target="_blank">Ver Mapa</a>`; } });
             }, { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 });
         }
         function calculateDistance(lat1, lon1, lat2, lon2) {
             if (lat1 == null || lon1 == null || lat2 == null || lon2 == null) return Infinity;
             const R = 6371; const dLat = deg2rad(lat2 - lat1); const dLon = deg2rad(lon2 - lon1);
             const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
             const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c;
         }
         function deg2rad(deg) { return deg * (Math.PI / 180); }

        // --- Carga y gestión de Jugadores ---
        async function loadPlayers(nameFilter = "", gameLevelFilter = "", localityFilter = "") {
            const playersResults = document.getElementById("playersResults");
            const playersFeedback = document.getElementById("playersFeedback");
            playersResults.innerHTML = '<div class="loader"></div>';
            playersFeedback.innerHTML = "";
            playersDataMap.clear(); // Limpiar datos anteriores

            // --- CORRECCIÓN AQUÍ ---
            // Seleccionar solo columnas existentes. Quitar bio, availability, preferred_position
            let query = supabaseClient.from("profiles").select("id, full_name, profile_pic, birth_date, gender, game_level, locality, phone");

            if (nameFilter) query = query.ilike("full_name", `%${nameFilter}%`);
            if (gameLevelFilter) query = query.ilike("game_level", `%${gameLevelFilter}%`);
            if (localityFilter) query = query.ilike("locality", `%${localityFilter}%`);
            if (loggedUser) query = query.neq('id', loggedUser.id);
            query = query.order('full_name');

            const { data, error } = await query;

            playersResults.innerHTML = ""; // Limpiar loader

            if (error) {
                // Mostrar el error específico de Supabase si es relevante
                playersFeedback.innerHTML = `<p style="color:red;">Error al cargar jugadores: ${error.message}</p>`;
                console.error("Error Supabase loadPlayers:", error); // Loguear el error completo
                return;
            }
            if (!data || data.length === 0) {
                playersResults.innerHTML = '<p style="text-align:center; width:100%;">No se encontraron jugadores.</p>';
                return;
            }

            data.forEach(player => {
                playersDataMap.set(player.id, player); // Guardar datos existentes

                const card = document.createElement("div");
                card.className = "player-card";
                card.setAttribute("onclick", `showPlayerModal('${player.id}')`); // Llamar al modal con ID

                card.innerHTML = `
                    <img src="${player.profile_pic || "https://via.placeholder.com/80"}" alt="Foto de ${player.full_name}" />
                    <h3>${player.full_name || 'Nombre no disponible'}</h3>
                    <p><i class="fas fa-layer-group"></i> ${player.game_level || "N/D"}</p>
                    <p><i class="fas fa-location-dot"></i> ${player.locality || "N/D"}</p>
                `;
                playersResults.appendChild(card);
            });
        }

        // --- Mostrar Modal del Jugador ---
        function showPlayerModal(playerId) {
            const player = playersDataMap.get(playerId);
            if (!player) {
                console.error("No se encontraron datos para el jugador con ID:", playerId);
                alert("Error al cargar los detalles del jugador.");
                return;
            }

            const modal = document.getElementById("playerModal");
            const modalContent = document.getElementById("playerModalContent");
            modalContent.innerHTML = ""; // Limpiar

            const edad = calculateAge(player.birth_date);
            const profilePic = player.profile_pic || "https://via.placeholder.com/180";

            let whatsappHTML = '';
            if (player.phone) {
                const phoneNumber = player.phone.replace(/\D/g, '');
                 let whatsappNumber = phoneNumber;
                 // Lógica básica de prefijo Argentina (ajustar si es necesario)
                 if (phoneNumber.length > 8 && phoneNumber.length < 12 && !phoneNumber.startsWith('54')) { whatsappNumber = '549' + phoneNumber; }
                 else if (phoneNumber.length === 8 && player.locality && player.locality.toLowerCase().includes('capital federal')) { whatsappNumber = '5411' + phoneNumber; } // Ejemplo muy básico

                whatsappHTML = `<p class="whatsapp-link"><i class="fab fa-whatsapp fa-fw"></i> <a href="https://wa.me/${whatsappNumber}" target="_blank">Enviar Mensaje</a></p>`;
            } else {
                whatsappHTML = '<p><i class="fab fa-whatsapp fa-fw"></i> No provisto</p>';
            }

            // Usar 'player.bio || "..."' etc., funcionará aunque 'bio' sea undefined
            modalContent.innerHTML = `
                <button class="close-modal" onclick="closePlayerModal()" title="Cerrar"><i class="fas fa-times"></i></button>
                <div class="player-image-column">
                    <img src="${profilePic}" alt="Foto de ${player.full_name}" />
                </div>
                <div class="player-details-column">
                    <h2>${player.full_name || 'Jugador'}</h2>
                    <p><i class="fas fa-cake-candles fa-fw"></i> ${edad} años</p>
                    <p><i class="fas fa-venus-mars fa-fw"></i> ${player.gender || "N/D"}</p>
                    <p><i class="fas fa-layer-group fa-fw"></i> Nivel: ${player.game_level || "N/D"}</p>
                    <p><i class="fas fa-location-dot fa-fw"></i> ${player.locality || "N/D"}</p>
                    <p><i class="fas fa-phone fa-fw"></i> ${player.phone || "No provisto"}</p>
                    ${whatsappHTML}

                    <div class="placeholder-section">
                        <h4><i class="fas fa-user fa-fw"></i> Sobre mí</h4>
                        <p>${player.bio || "El jugador aún no ha añadido una descripción."}</p>
                    </div>
                     <div class="placeholder-section">
                        <h4><i class="fas fa-calendar-check fa-fw"></i> Disponibilidad</h4>
                        <p>${player.availability || "No especificada."}</p>
                    </div>
                     <div class="placeholder-section">
                        <h4><i class="fas fa-arrows-left-right fa-fw"></i> Posición</h4>
                        <p>${player.preferred_position || "No especificada."}</p>
                    </div>
                </div>
            `;

            modal.style.display = "flex";
        }


        // --- Inicialización al Cargar la Página ---
        document.addEventListener("DOMContentLoaded", async () => {
            await checkProfile();
            await preloadEstablishments();
            await preloadPlayersData();

             if (loggedUser && document.getElementById("profileLink").textContent === "Mi Perfil") {
                 showPartidosSearch();
             } else {
                 hideAllSections();
             }
        });

    </script>
</body>
</html>